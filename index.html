<!--
çŸ­å½±éŸ³è…³æœ¬ç”Ÿæˆå™¨ï¼ˆå‰ç«¯ + å®‰å…¨ä»£ç†ï¼‰
==================================

ğŸ¯ ç›®æ¨™
â€” è®“ä½¿ç”¨è€…ä¸Šå‚³é€å­—ç¨¿ï¼ˆ.srt / .txtï¼‰æˆ–è²¼ä¸Šæ–‡ç« ï¼Œé¸æ“‡å½±ç‰‡å‹æ…‹ï¼ŒæŒ‰ä¸‹ã€Œç”Ÿæˆã€ï¼Œå³å¾—åˆ° 60 ç§’å…§çš„çŸ­å½±éŸ³è…³æœ¬ã€‚

ğŸ”§ æ¶æ§‹
â€” GitHub Pagesï¼šç´”å‰ç«¯ï¼ˆæœ¬æª” index.htmlï¼‰ã€‚
â€” Cloudflare Workersï¼ˆæˆ–ä»»ä½• Serverlessï¼‰ï¼šä½œç‚º OpenAI API ä»£ç†ï¼Œå®‰å…¨ä¿å­˜ API Keyï¼ˆ/api/generateï¼‰ã€‚

ğŸ“¦ åŠŸèƒ½
1) ä¸Šå‚³/è²¼ä¸Šå…§å®¹ï¼šæ”¯æ´ .srt/.txtï¼Œæˆ–ç›´æ¥è²¼æ–‡ã€‚
2) è‡ªå‹•è§£æï¼š
   â€¢ SRT è§£æç‚º time-coded é€å­—ç¨¿
   â€¢ ç´”æ–‡å­—è‡ªå‹•æ–·å¥ + å‡è¨­ 180 wpm ä¼°è¨ˆæ™‚é–“ç¢¼
3) ä¸‰ç¨®è…³æœ¬å‹æ…‹ï¼š
   â€¢ Podcast ä¸€é¡åˆ°åº•å‹ï¼ˆ5 æ®µ 45â€“75 ç§’ï¼Œé™„æ™‚é–“ç¢¼ + é‡é»ï¼‰
   â€¢ è­°é¡Œå‹ï¼ˆ60 ç§’å…§æ—ç™½è…³æœ¬ + å»ºè­°æ™‚é–“/ç•«é¢ï¼‰
   â€¢ äººç‰©æ•…äº‹å‹ï¼ˆ60 ç§’å…§è…³æœ¬ï¼šåŸéŸ³æ‘˜éŒ„ + æ—ç™½ + ç•«é¢ï¼‰
4) å‰ç«¯ç„¡é‡‘é‘°ï¼šä»¥ Serverless ä»£ç†å‘¼å« OpenAIï¼Œé¿å…é‡‘é‘°å¤–æ´©ã€‚
5) ä¸‹è¼‰ï¼šæ”¯æ´è¤‡è£½ã€ä¸‹è¼‰ .md / .txt

ğŸš€ éƒ¨ç½²æ­¥é©Ÿï¼ˆæ‘˜è¦ï¼‰
1) å°‡æœ¬æª”æ¡ˆåšç‚ºä½ çš„ GitHub Pages ä¹‹ index.htmlã€‚
2) æ–¼ Cloudflare Workers éƒ¨ç½² /api/generateï¼ˆworker ç¨‹å¼è¦‹æœ¬æ–‡æœ€ä¸‹æ–¹ <script type="text/plain" id="worker-js"> å€å¡Šï¼‰ã€‚
3) åœ¨ index.html çš„ CONFIG.API_BASE è¨­å®šä½ çš„ Workers ç¶²åŸŸï¼Œä¾‹å¦‚ï¼šhttps://your-worker.your-subdomain.workers.dev

â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€”
-->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>çŸ­å½±éŸ³è…³æœ¬ç”Ÿæˆå™¨</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --card: 255 255 255; --ink: 17 24 39; --muted: 107 114 128; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, 'Helvetica Neue', Arial; }
    .card { background: rgb(var(--card)); box-shadow: 0 10px 25px rgba(0,0,0,.06); border-radius: 1.25rem; }
    .btn { border-radius: 9999px; padding: .75rem 1rem; font-weight: 600; }
    .btn-primary { background: #0ea5e9; color: white; }
    .btn-ghost { background: #f3f4f6; color: rgb(var(--ink)); }
    textarea { tab-size: 2; }
    .mono { font-feature-settings: "ss01" 1, "ss02" 1; }
    .code { background: #0f172a; color: #e2e8f0; border-radius: .75rem; padding: 1rem; overflow: auto; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="max-w-6xl mx-auto px-4 py-10">
    <h1 class="text-3xl md:text-4xl font-bold tracking-tight">çŸ­å½±éŸ³è…³æœ¬ç”Ÿæˆå™¨</h1>
    <p class="text-slate-600 mt-2">éƒ¨ç½²æç¤ºï¼šæ­¤ç‰ˆæœ¬å·²ç‚º GitHub Pages çš„ã€Œå°ˆæ¡ˆç¶²ç«™ã€æœ€ä½³åŒ–ï¼ˆrepoï¼š<code>short-video-writer</code>ï¼‰ã€‚è«‹å…ˆåˆ°ç¨‹å¼æœ€ä¸‹æ–¹ã€ŒCONFIG.API_BASEã€æ”¹æˆä½ çš„ Cloudflare Workers ç¶²å€ï¼Œå†æäº¤å³å¯ä½¿ç”¨ã€‚è‹¥å°šæœªéƒ¨ç½² Workerï¼Œé é¢ä»å¯é–‹å•Ÿä½†ç„¡æ³•å‘¼å«ç”Ÿæˆ APIã€‚</p>
  </header>

  <main class="max-w-6xl mx-auto px-4 grid md:grid-cols-5 gap-6 pb-24">
    <!-- å·¦å´ï¼šè¼¸å…¥å€ -->
    <section class="md:col-span-3 space-y-6">
      <div class="card p-6">
        <h2 class="text-xl font-semibold mb-4">ç¬¬ä¸€æ­¥ï¼šä¸Šå‚³æˆ–è²¼ä¸Šå…§å®¹</h2>
        <div class="grid md:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm text-slate-600">ä¸Šå‚³é€å­—ç¨¿ï¼ˆ.srt / .txtï¼‰</span>
            <input id="fileInput" type="file" accept=".srt,.txt" class="mt-2 block w-full text-sm" />
          </label>
          <div class="flex items-end">
            <button id="btnClear" class="btn btn-ghost w-full">æ¸…ç©º</button>
          </div>
        </div>
        <label class="block mt-4">
          <span class="text-sm text-slate-600">æˆ–ç›´æ¥è²¼ä¸Šæ–‡ç« /é€å­—ç¨¿</span>
          <textarea id="rawInput" rows="10" class="mt-2 w-full p-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="è²¼ä¸Š .srtï¼ˆå«æ™‚é–“ç¢¼ï¼‰æˆ–ç´”æ–‡å­—å…§å®¹â€¦"></textarea>
        </label>
        <div class="mt-3 text-xs text-slate-500">æç¤ºï¼šç´”æ–‡å­—æœƒè‡ªå‹•ä¼°ç®—æ™‚é–“ç¢¼ï¼ˆä»¥ 180 wpm æ¨ä¼°ï¼‰ã€‚</div>
      </div>

      <div class="card p-6">
        <h2 class="text-xl font-semibold mb-4">ç¬¬äºŒæ­¥ï¼šé¸æ“‡å½±ç‰‡å‹æ…‹</h2>
        <div class="grid md:grid-cols-3 gap-4">
          <label class="flex gap-3 items-start p-3 rounded-lg border border-slate-200 hover:border-sky-300 cursor-pointer">
            <input type="radio" name="mode" value="podcast" class="mt-1" checked>
            <div>
              <div class="font-semibold">Podcast ä¸€é¡åˆ°åº•å‹</div>
              <div class="text-sm text-slate-600">è¼¸å‡º 5 æ®µ 45â€“75 ç§’é€£çºŒç‰‡æ®µï¼Œé™„æ™‚é–“ç¢¼èˆ‡é‡é»ã€‚</div>
            </div>
          </label>
          <label class="flex gap-3 items-start p-3 rounded-lg border border-slate-200 hover:border-sky-300 cursor-pointer">
            <input type="radio" name="mode" value="topic" class="mt-1">
            <div>
              <div class="font-semibold">è­°é¡Œå‹</div>
              <div class="text-sm text-slate-600">ä¾å…§å®¹å¯« 60 ç§’æ—ç™½è…³æœ¬ï¼Œé™„å»ºè­°æ™‚é–“èˆ‡ç•«é¢ã€‚</div>
            </div>
          </label>
          <label class="flex gap-3 items-start p-3 rounded-lg border border-slate-200 hover:border-sky-300 cursor-pointer">
            <input type="radio" name="mode" value="people" class="mt-1">
            <div>
              <div class="font-semibold">äººç‰©æ•…äº‹å‹</div>
              <div class="text-sm text-slate-600">60 ç§’è…³æœ¬ï¼šåŸéŸ³æ‘˜éŒ„ + å»ºè­°æ—ç™½ + ç•«é¢ã€‚</div>
            </div>
          </label>
        </div>

        <details class="mt-4">
          <summary class="cursor-pointer text-slate-700 font-medium">é€²éšé¸é …</summary>
          <div class="grid md:grid-cols-3 gap-4 mt-4">
            <label class="block">
              <span class="text-sm text-slate-600">èªæ°£/é¢¨æ ¼</span>
              <select id="tone" class="mt-2 w-full p-2 rounded-lg border border-slate-200">
                <option value="ä¸­æ€§å°ˆæ¥­">ä¸­æ€§å°ˆæ¥­</option>
                <option value="æ„Ÿäººæ•…äº‹">æ„Ÿäººæ•…äº‹</option>
                <option value="è³‡è¨Šçˆ†é»">è³‡è¨Šçˆ†é»</option>
                <option value="æ‡¸ç–‘é‹ªé™³">æ‡¸ç–‘é‹ªé™³</option>
                <option value="æ´»æ½‘è¦ªå­">æ´»æ½‘è¦ªå­</option>
              </select>
            </label>
            <label class="block">
              <span class="text-sm text-slate-600">ç›®æ¨™è§€çœ¾</span>
              <input id="audience" class="mt-2 w-full p-2 rounded-lg border border-slate-200" placeholder="å¦‚ï¼šå®¶é•·ã€è€å¸«ã€é’å°‘å¹´â€¦" />
            </label>
            <label class="block">
              <span class="text-sm text-slate-600">ç¦ç”¨è©ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</span>
              <input id="banned" class="mt-2 w-full p-2 rounded-lg border border-slate-200" placeholder="å¦‚ï¼šéœ‡æ’¼ã€çˆ†â€¦" />
            </label>
          </div>
        </details>
      </div>

      <div class="card p-6">
        <h2 class="text-xl font-semibold mb-4">ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆ</h2>
        <div class="flex flex-wrap gap-3">
          <button id="btnGenerate" class="btn btn-primary flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 6v12m6-6H6"/></svg>
            ç¢ºèªç”Ÿæˆ
          </button>
          <button id="btnSample" class="btn btn-ghost">è¼‰å…¥ç¯„ä¾‹å…§å®¹</button>
        </div>
        <div id="sysMsg" class="mt-3 text-sm text-slate-600"></div>
      </div>
    </section>

    <!-- å³å´ï¼šè¼¸å‡ºå€ -->
    <section class="md:col-span-2 space-y-6">
      <div class="card p-6">
        <h2 class="text-xl font-semibold mb-4">ç¬¬å››æ­¥ï¼šç”Ÿæˆä¹‹å…§å®¹è…³æœ¬</h2>
        <div class="flex gap-2 mb-3">
          <button id="btnCopy" class="btn btn-ghost">è¤‡è£½</button>
          <button id="btnDownloadMd" class="btn btn-ghost">ä¸‹è¼‰ .md</button>
          <button id="btnDownloadTxt" class="btn btn-ghost">ä¸‹è¼‰ .txt</button>
        </div>
        <pre id="output" class="code text-sm whitespace-pre-wrap"></pre>
      </div>

      <div class="card p-6">
        <h2 class="text-lg font-semibold">è§£æçµæœï¼ˆåµæ¸¬åˆ°çš„æ™‚é–“ç¢¼èˆ‡ç‰‡æ®µï¼‰</h2>
        <div id="parsePreview" class="mt-3 text-sm text-slate-700 whitespace-pre-wrap"></div>
      </div>
    </section>
  </main>

  <script>
  const CONFIG = {
    API_BASE: 'https://<ä½ çš„-workerså­åŸŸ>.workers.dev' // â† å…ˆæ”¹æˆä½ çš„ Cloudflare Workers ç¶²å€ï¼Œä¾‹å¦‚ï¼šhttps://svscript-liuyingjun.workers.dev, // â† æ›æˆä½ çš„ Workers ç¶²åŸŸ
    ENDPOINT: '/api/generate',
    INFER_WPM: 180, // ç´”æ–‡å­—ä¼°ç®—èªé€Ÿï¼ˆæ¯åˆ†é˜å­—æ•¸ï¼‰
  };

  // â€”â€”â€”â€”â€”â€”â€”â€” å°å·¥å…· â€”â€”â€”â€”â€”â€”â€”â€”
  const el = (id) => document.getElementById(id);
  const fmtTime = (sec) => {
    sec = Math.max(0, Math.floor(sec));
    const h = String(Math.floor(sec / 3600)).padStart(2,'0');
    const m = String(Math.floor((sec % 3600) / 60)).padStart(2,'0');
    const s = String(sec % 60).padStart(2,'0');
    return (h==='00'? `${m}:${s}` : `${h}:${m}:${s}`);
  }

  // â€”â€”â€”â€”â€”â€”â€”â€” SRT è§£æ â€”â€”â€”â€”â€”â€”â€”â€”
  function parseSRT(text) {
    const blocks = text.replace(/\r/g,'').split(/\n\n+/).map(b=>b.trim()).filter(Boolean);
    const cues = [];
    for (const b of blocks) {
      const lines = b.split(/\n/);
      if (lines.length >= 2) {
        const timeLine = lines[1].match(/(\d{2}:\d{2}:\d{2}[.,]\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2}[.,]\d{3})/);
        if (!timeLine) continue;
        const start = toSeconds(timeLine[1]);
        const end = toSeconds(timeLine[2]);
        const text = lines.slice(2).join(' ').replace(/<[^>]+>/g,'').trim();
        if (text) cues.push({ start, end, text });
      }
    }
    return cues;
  }
  function toSeconds(t) {
    const [hh,mm,ssms] = t.replace(',', '.').split(':');
    const [ss, ms] = ssms.split('.');
    return (+hh)*3600 + (+mm)*60 + (+ss) + (+ms)/1000;
  }

  // â€”â€”â€”â€”â€”â€”â€”â€” ç´”æ–‡å­—ä¼°æ™‚ â€”â€”â€”â€”â€”â€”â€”â€”
  function estimateCuesFromText(text, wpm = CONFIG.INFER_WPM) {
    // ä»¥å¥è™Ÿ/æ›è¡Œæ–·å¥ï¼Œä¼°æ¯å­—ç§’æ•¸
    const chars = text.replace(/\s+/g,' ').trim();
    if (!chars) return [];
    const words = chars.split(/\s+/).length;
    const totalSeconds = Math.max(10, Math.round((words / wpm) * 60));
    // ç²—ç•¥æ¯å¥åˆ‡æ™‚é–“
    const segments = chars.split(/(?<=[ã€‚ï¼ï¼Ÿ!?,ï¼Œ\n])/);
    const durPerChar = totalSeconds / chars.length;
    let t = 0; const cues = [];
    for (const seg of segments) {
      const d = Math.max(0.5, Math.round(seg.length * durPerChar));
      const start = t; const end = t + d; t = end;
      const text = seg.trim(); if (text) cues.push({ start, end, text });
    }
    return cues;
  }

  // â€”â€”â€”â€”â€”â€”â€”â€” é€£çºŒç‰‡æ®µæ¨è–¦ï¼ˆæ‰¾ 45â€“75 ç§’ï¼‰ â€”â€”â€”â€”â€”â€”â€”â€”
  function suggestWindows(cues, min=45, max=75, topK=5) {
    // æ»‘å‹•çª—ï¼šä»¥ cue é‚Šç•Œçµ„æˆé€£çºŒçª—ï¼Œåˆ†æ•¸ = æœŸé–“å…§å­—æ•¸
    const points = [...new Set(cues.flatMap(c=>[c.start, c.end]))].sort((a,b)=>a-b);
    const windows = [];
    for (let i=0; i<points.length; i++){
      for (let j=i+1; j<points.length; j++){
        const s = points[i], e = points[j];
        const dur = e - s; if (dur < min || dur > max) continue;
        const within = cues.filter(c=> c.start >= s && c.end <= e);
        const score = within.reduce((acc,c)=> acc + c.text.length, 0);
        windows.push({ start:s, end:e, dur:dur, score, text: within.map(c=>c.text).join(' ') });
      }
    }
    windows.sort((a,b)=> b.score - a.score);
    // å»é‡/é¿å…é‡ç–Šéé«˜ï¼ˆIoU > 0.6ï¼‰
    const pick = [];
    for (const w of windows){
      if (pick.length >= topK) break;
      const ok = pick.every(p=> overlapRatio(p,w) < 0.6);
      if (ok) pick.push(w);
    }
    return pick.map(w=> ({
      start: w.start, end: w.end, duration: Math.round(w.dur),
      timestr: `${fmtTime(w.start)}â€“${fmtTime(w.end)}`,
      text: w.text.trim()
    }));
  }
  function overlapRatio(a,b){
    const inter = Math.max(0, Math.min(a.end,b.end) - Math.max(a.start,b.start));
    const uni = (a.end-a.start) + (b.end-b.start) - inter;
    return uni ? inter/uni : 0;
  }

  // â€”â€”â€”â€”â€”â€”â€”â€” Prompt æ¨¡æ¿ â€”â€”â€”â€”â€”â€”â€”â€”
  function buildPrompt(mode, payload){
    const base = `ä½ æ˜¯å°ç£ä¸­æ–‡å…§å®¹è£½ä½œçš„çŸ­å½±éŸ³è…³æœ¬ç·¨åŠ‡ï¼Œè«‹ç”¨ç¹é«”ä¸­æ–‡è¼¸å‡ºã€‚ä¸è¦åŒ…å«é“æ­‰æˆ–å¤šé¤˜èªªæ˜ã€‚æ‰€æœ‰è¼¸å‡ºä¸€å¾‹ç”¨ Markdown æ ¼å¼ã€‚`;

    const common = `
ã€å—çœ¾ã€‘${payload.audience || 'ä¸€èˆ¬å¤§çœ¾'}
ã€èªæ°£ã€‘${payload.tone || 'ä¸­æ€§å°ˆæ¥­'}
ã€ç¦ç”¨è©ã€‘${payload.banned || 'ï¼ˆç„¡ï¼‰'}
è«‹é¿å…å‡ºç¾ç¦ç”¨è©çš„åŒç¾©é‡è¿°èˆ‡è®Šå½¢ã€‚
`;

    const content = payload.text;
    const detected = payload.detectedWindows || [];

    if (mode === 'podcast'){
      return `${base}
${common}
å·²è§£æçš„é€å­—ç¨¿ç‰‡æ®µï¼ˆä¾›åƒè€ƒï¼‰ï¼š\n${detected.map((w,i)=>`${i+1}. ${w.timestr}ï½œ${w.text.slice(0,80)}â€¦`).join('\n')}

ä»»å‹™ï¼šå¾å®Œæ•´é€å­—ç¨¿ä¸­ï¼Œç²¾é¸ 5 æ®µã€Œå¯ä¸€é¡åˆ°åº•ã€çš„é€£çºŒç‰‡æ®µï¼ˆæ¯æ®µ 45â€“75 ç§’ï¼‰ï¼Œä»¥ä¾¿å‰ªæˆçŸ­å½±éŸ³ã€‚
è¼¸å‡ºæ ¼å¼ï¼ˆMarkdownï¼‰ï¼š
### Podcast ä¸€é¡åˆ°åº•æ¨è–¦ï¼ˆ5 æ®µï¼‰
1) æ™‚é–“ç¢¼ï¼šèµ·è¨–ï¼ˆmm:ssâ€“mm:ssï¼‰
   å…§å®¹æ‘˜è¦ï¼šä¸‰å¥ä»¥å…§
   å…§å®¹é‡é»ï¼šâ€¢ â€¦ â€¢ â€¦
2) â€¦ï¼ˆå…± 5 æ®µï¼‰

è¦å‰‡ï¼š
- åƒ…æŒ‘ã€Œé€£çºŒã€ä¸”èªæ„å®Œæ•´çš„ç‰‡æ®µã€‚
- å„ªå…ˆæœ‰æ¸…æ¥šèµ·æ‰¿è½‰åˆã€é‡‘å¥ã€å®šç¾©ã€è¡Œå‹•å»ºè­°çš„ç‰‡æ®µã€‚
- è‹¥é€å­—ç¨¿ç„¡æ³•ç²¾ç¢ºæ™‚é–“ï¼Œè«‹ä¿ç•™ä¼°è¨ˆå€¼ä¸¦æ¨™è¨»ã€Œç´„ã€ã€‚
- ä¸è¦åŠ å…¥æ—ç™½æˆ– B-roll å»ºè­°ï¼ˆæœ¬å‹æ…‹åªè¦æ™‚é–“ç¢¼+é‡é»ï¼‰ã€‚

ä»¥ä¸‹æ˜¯é€å­—ç¨¿å…¨æ–‡ï¼š\n${content}`;
    }

    if (mode === 'topic'){
      return `${base}
${common}
ä»»å‹™ï¼šæ ¹æ“šæä¾›å…§å®¹ï¼Œå¯«å‡ºã€Œ60 ç§’å…§ã€çš„è­°é¡Œå‹çŸ­å½±éŸ³æ—ç™½è…³æœ¬ï¼Œä¸¦é™„ä¸Šå»ºè­°æ™‚é–“èˆ‡ç•«é¢ï¼ˆB-roll/å­—å¹•ï¼‰ã€‚
è¼¸å‡ºæ ¼å¼ï¼ˆMarkdownï¼‰ï¼š
### è­°é¡Œå‹ 60 ç§’è…³æœ¬
- 00â€“05sï½œé–‹å ´é‰¤å­ï¼šâ€¦ï¼ˆå­—å¹•ï¼šâ€¦ï¼‰
- 05â€“25sï½œèƒŒæ™¯/æ•¸æ“šï¼šâ€¦ï¼ˆç•«é¢ï¼šâ€¦ï¼‰
- 25â€“45sï½œè§€é»/å°æ¯”ï¼šâ€¦ï¼ˆç•«é¢ï¼šâ€¦ï¼‰
- 45â€“60sï½œè¡Œå‹•å‘¼ç±²/æ”¶æŸï¼šâ€¦ï¼ˆç•«é¢ï¼šâ€¦ï¼‰
è£œå……ï¼šå¯åˆ— 3 çµ„å‚™ç”¨é–‹å ´é‰¤å­ï¼ˆ10 å­—å…§ï¼‰ã€‚

è¦å‰‡ï¼š
- åš´æ ¼æ§åˆ¶åœ¨ 60 ç§’å…§ï¼ˆå£æ’­ç´„ 140â€“160 å­—ï¼‰ã€‚
- ä½¿ç”¨å°ç£ç”¨èªèˆ‡æ¨™é»ã€‚
- è‹¥åŸæ–‡å«æ•¸æ“šï¼Œè«‹ç°¡æ½”å¼•ç”¨ä¸¦æ¨™è¨»ä¾†æºï¼ˆè‹¥æœªçŸ¥å‰‡å¯«ã€Œè³‡æ–™ä¾†æºï¼šåŸæ–‡æä¾›ã€ï¼‰ã€‚

ä»¥ä¸‹æ˜¯å…¨æ–‡ï¼š\n${content}`;
    }

    // people
    return `${base}
${common}
ä»»å‹™ï¼šæ ¹æ“šæä¾›å…§å®¹ï¼Œå¯«å‡ºã€Œ60 ç§’å…§ã€çš„äººç‰©æ•…äº‹å‹è…³æœ¬ï¼Œéœ€åŒ…å«ã€ŒåŸéŸ³æ‘˜éŒ„ï¼ˆé™„å¤§æ„ï¼‰ã€ï¼‹ã€Œå»ºè­°æ—ç™½ã€ï¼‹ã€Œå»ºè­°ç•«é¢ã€ã€‚
è¼¸å‡ºæ ¼å¼ï¼ˆMarkdownï¼‰ï¼š
### äººç‰©æ•…äº‹å‹ 60 ç§’è…³æœ¬
- 00â€“08sï½œåŸéŸ³ï¼šâ€¦ï¼ˆå¤§æ„ï¼šâ€¦ï¼‰ï¼ç•«é¢ï¼šâ€¦ï¼æ—ç™½ï¼šâ€¦
- 08â€“25sï½œåŸéŸ³ï¼šâ€¦ï¼ˆå¤§æ„ï¼šâ€¦ï¼‰ï¼ç•«é¢ï¼šâ€¦ï¼æ—ç™½ï¼šâ€¦
- 25â€“45sï½œåŸéŸ³ï¼šâ€¦ï¼ˆå¤§æ„ï¼šâ€¦ï¼‰ï¼ç•«é¢ï¼šâ€¦ï¼æ—ç™½ï¼šâ€¦
- 45â€“60sï½œåŸéŸ³ï¼šâ€¦ï¼ˆå¤§æ„ï¼šâ€¦ï¼‰ï¼ç•«é¢ï¼šâ€¦ï¼æ—ç™½ï¼šâ€¦
å‚™è¨»ï¼šè‹¥åŸæ–‡æ²’æœ‰å¯ç”¨åŸéŸ³ï¼Œè«‹ä»¥å¼•è™Ÿæ¨™ç¤ºã€Œæ“¬çœŸåŸéŸ³ã€ä¸¦æ¸…æ¥šè¨»è¨˜ã€‚

è¦å‰‡ï¼š
- åš´æ ¼æ§åˆ¶åœ¨ 60 ç§’å…§ã€‚
- åŸéŸ³ç”¨çŸ­å¥ã€é—é˜ã€å¯è²¼å­—å¹•ï¼›æ—ç™½è£œè¶³æƒ…ç·’èˆ‡è„ˆçµ¡ã€‚

ä»¥ä¸‹æ˜¯å…¨æ–‡ï¼š\n${content}`;
  }

  // â€”â€”â€”â€”â€”â€”â€”â€” UI ç¶å®š â€”â€”â€”â€”â€”â€”â€”â€”
  const fileInput = el('fileInput');
  const rawInput = el('rawInput');
  const parsePreview = el('parsePreview');
  const output = el('output');
  const sysMsg = el('sysMsg');

  fileInput.addEventListener('change', async (e) => {
    const f = e.target.files?.[0];
    if (!f) return; const text = await f.text();
    rawInput.value = text;
    runParsePreview();
  });
  el('btnClear').addEventListener('click', ()=>{
    fileInput.value = '';
    rawInput.value = '';
    parsePreview.textContent = '';
    output.textContent = '';
  });
  rawInput.addEventListener('input', runParsePreview);

  function runParsePreview(){
    const text = rawInput.value.trim();
    if (!text){ parsePreview.textContent = ''; return; }
    const isSrt = /-->/.test(text) && /\d{2}:\d{2}:\d{2}[.,]\d{3}/.test(text);
    const cues = isSrt ? parseSRT(text) : estimateCuesFromText(text);
    const picks = suggestWindows(cues, 45, 75, 5);
    const lines = [
      `åµæ¸¬é¡å‹ï¼š${isSrt?'SRTï¼ˆå«æ™‚é–“ç¢¼ï¼‰':'ç´”æ–‡å­—ï¼ˆä¼°ç®—æ™‚é–“ï¼‰'}`,
      `å…±è§£æ ${cues.length} å€‹å¥æ®µ`,
      `æ¨è–¦ 45â€“75 ç§’ç‰‡æ®µï¼ˆè‡³å¤š 5 æ®µï¼‰ï¼š`,
      ...picks.map((w,i)=>`${i+1}. ${w.timestr}ï½œç´„ ${w.duration}sï½œ${w.text.slice(0,100)}â€¦`)
    ];
    parsePreview.textContent = lines.join('\n');
    // æš«å­˜åˆ° dataset
    parsePreview.dataset.detected = JSON.stringify(picks);
  }

  el('btnSample').addEventListener('click', ()=>{
    rawInput.value = `1\n00:00:00,000 --> 00:00:04,000\nå¤§å®¶å¥½ï¼Œæ­¡è¿æ”¶è½è¦ªå¸«é—œéµå­—ï¼Œæˆ‘æ˜¯ä¸»æŒäººã€‚\n\n2\n00:00:04,200 --> 00:00:12,000\nä»Šå¤©æˆ‘å€‘è¦è«‡ã€ŒAI è‡ªå­¸ã€ï¼Œè¿‘å¹´è¶Šä¾†è¶Šå¤šå­©å­æŠŠ AI ç•¶æˆå­¸ç¿’èˆ‡èŠå¤©çš„å¤¥ä¼´ã€‚\n\n3\n00:00:12,100 --> 00:00:24,000\nåƒæ˜¯ä¸€ä½åœ‹å°äº”å¹´ç´šå­¸ç”Ÿï¼Œä»–ç”¨ AI å¯«ç¨‹å¼åšå‡º Apple Watch è¨˜å¸³ Appï¼Œé€™ä¹Ÿè®“å®¶é•·æ€è€ƒè©²å¦‚ä½•é™ªä¼´ã€‚\n\n4\n00:00:24,000 --> 00:00:38,000\nä¸éï¼Œéåº¦ä¾è³´ä¹Ÿå¯èƒ½é€ æˆåˆ¤æ–·åŠ›èˆ‡æƒ…ç·’çš„å½±éŸ¿ï¼Œä»Šå¤©æˆ‘å€‘å°±å¾ä¸‰å€‹å•é¡Œä¾†èŠèŠã€‚\n\n5\n00:00:38,100 --> 00:00:50,000\nç¬¬ä¸€ï¼Œå®¶é•·å¦‚ä½•è¾¨è­˜å­©å­èˆ‡ AI äº’å‹•çš„å“è³ªï¼Ÿç¬¬äºŒï¼Œå­¸æ ¡è©²æ€éº¼å¼•å°ï¼Ÿç¬¬ä¸‰ï¼Œæœ‰å“ªäº›å¯¦éš›é™ªä¼´ç­–ç•¥ï¼Ÿ`;
    runParsePreview();
  });

  el('btnGenerate').addEventListener('click', async ()=>{
    const text = rawInput.value.trim();
    if (!text) { sysMsg.textContent = 'è«‹å…ˆä¸Šå‚³æˆ–è²¼ä¸Šå…§å®¹'; return; }
    const mode = document.querySelector('input[name="mode"]:checked')?.value || 'podcast';
    const tone = el('tone').value; const audience = el('audience').value; const banned = el('banned').value;
    const detectedWindows = JSON.parse(parsePreview.dataset.detected || '[]');

    const prompt = buildPrompt(mode, { text, tone, audience, banned, detectedWindows });
    output.textContent = 'â³ ç”Ÿæˆä¸­â€¦\n\n' + prompt.slice(0, 600) + (prompt.length>600?'\nâ€¦ï¼ˆç•¥ï¼‰':'');
    sysMsg.textContent = 'å·²é€å‡ºè«‹æ±‚ï¼Œç´„éœ€æ•¸ç§’ã€‚';

    try {
      const res = await fetch(`${CONFIG.API_BASE}${CONFIG.ENDPOINT}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, mode })
      });
      if (!res.ok){
        const t = await res.text(); throw new Error(`API éŒ¯èª¤ï¼š${res.status} ${t}`);
      }
      const data = await res.json();
      output.textContent = (data.text || '').trim();
      sysMsg.textContent = 'âœ… å·²å®Œæˆ';
    } catch (err){
      output.textContent = String(err);
      sysMsg.textContent = 'âŒ ç™¼ç”ŸéŒ¯èª¤';
    }
  });

  el('btnCopy').addEventListener('click', async ()=>{
    const t = output.textContent; if (!t) return;
    await navigator.clipboard.writeText(t);
    sysMsg.textContent = 'å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿';
  });
  el('btnDownloadMd').addEventListener('click', ()=> download('script.md', output.textContent));
  el('btnDownloadTxt').addEventListener('click', ()=> download('script.txt', output.textContent));

  function download(name, content){
    const blob = new Blob([content], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click();
    setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
  }
  </script>

  <!--
  ===============================
  Serverless ä»£ç†ï¼ˆCloudflare Workersï¼‰
  ===============================
  ç”¨é€”ï¼šä¿è­· OpenAI API Keyã€‚å°‡ä»¥ä¸‹ JS å­˜ç‚º worker.jsï¼Œæ–¼ Cloudflare Workers éƒ¨ç½²ï¼Œä¸¦è¨­å®šç’°å¢ƒè®Šæ•¸ï¼š
  â€¢ OPENAI_API_KEY = sk-xxxxx
  â€¢ MODEL = gpt-5.1-miniï¼ˆæˆ–ä½ å¸Œæœ›çš„æ¨¡å‹ï¼‰

  è·¯å¾‘ï¼š/api/generate
  è·¨ç¶²åŸŸï¼šè«‹è¦–æƒ…æ³èª¿æ•´ CORSã€‚
  -->
  <script type="text/plain" id="worker-js">// worker.js
export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    if (url.pathname !== '/api/generate') return new Response('Not Found', { status: 404 });

    if (request.method === 'OPTIONS') {
      return new Response(null, { headers: corsHeaders() });
    }

    try {
      const { prompt, mode } = await request.json();
      if (!prompt) return json({ error: 'Missing prompt' }, 400);

      // ä½ ä¹Ÿå¯ä»¥ä¾ mode åˆ‡æ›ä¸åŒç³»çµ±æç¤ºæˆ–æ¨¡å‹
      const model = env.MODEL || 'gpt-5.1-mini';

      const payload = {
        model,
        messages: [
          { role: 'system', content: 'You are a helpful assistant that writes Traditional Chinese short-video scripts in Markdown. Keep outputs concise and within 60 seconds when asked.' },
          { role: 'user', content: prompt }
        ],
        temperature: 0.7,
      };

      const r = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${env.OPENAI_API_KEY}` },
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if (!r.ok) return json({ error: j.error?.message || 'Upstream error' }, r.status);

      const text = j.choices?.[0]?.message?.content || '';
      return json({ text });
    } catch (e) {
      return json({ error: String(e) }, 500);
    }
  }
}

function corsHeaders(){
  return {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization'
  }
}

function json(data, status=200){
  return new Response(JSON.stringify(data), { status, headers: { 'Content-Type': 'application/json', ...corsHeaders() } });
}
</script>

  <!--
  ===============================
  è£œå……ï¼šè¼¸å‡º JSON çµæ§‹ï¼ˆè‹¥ä½ æƒ³çµ¦ç·¨è¼¯å™¨æˆ–å¾ŒçºŒæµç¨‹ä½¿ç”¨ï¼‰
  ===============================
  Podcast ä¸€é¡åˆ°åº•å‹ï¼ˆ5 æ®µï¼‰
  {
    "type": "podcast",
    "segments": [
      {"start": "00:12", "end": "01:05", "summary": "â€¦", "bullets": ["â€¦","â€¦"]},
      â€¦ x5
    ]
  }

  è­°é¡Œå‹ï¼ˆ60 ç§’ï¼‰
  {
    "type": "topic",
    "timeline": [
      {"range": "00â€“05s", "narration": "â€¦", "visual": "â€¦", "caption": "â€¦"},
      â€¦
    ],
    "hooks": ["â€¦","â€¦","â€¦"]
  }

  äººç‰©æ•…äº‹å‹ï¼ˆ60 ç§’ï¼‰
  {
    "type": "people",
    "timeline": [
      {"range": "00â€“08s", "raw": "â€¦", "gist": "â€¦", "narration": "â€¦", "visual": "â€¦"}, â€¦
    ]
  }
  -->
</body>
</html>
