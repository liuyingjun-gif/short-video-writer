<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>短影音腳本生成器（支援多模型）</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 基本樣式 */
    body { font-family: 'Inter', sans-serif; background: #f9fafb; color: #111827; }
    .card { background: white; border-radius: 1rem; box-shadow: 0 5px 20px rgba(0,0,0,.05); padding: 1.5rem; }
    
    /* 按鈕樣式 */
    .btn { border-radius: 9999px; padding: .6rem 1rem; font-weight: 600; transition: background-color 0.15s; }
    .btn-primary { background: #0284c7; color: #fff; }
    .btn-primary:hover:not(:disabled) { background: #0369a1; }
    .btn-ghost { background: #f3f4f6; color: #111827; }
    .btn-ghost:hover:not(:disabled) { background: #e5e7eb; }
    
    /* 禁用狀態 */
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* 程式碼與提示樣式 */
    .code { 
      background: #0f172a; 
      color: #e2e8f0; 
      border-radius: .75rem; 
      padding: 1rem; 
      overflow: auto; 
      white-space: pre-wrap; 
      font-size: 0.875rem;
    }
    .muted { color:#6b7280; font-size:12px }
    .warn { color:#dc2626; font-weight: 700; } 
  </style>
</head>
<body>
  <header class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-2">短影音腳本生成器 🎬</h1>
    <p class="text-gray-600">此版本支援 OpenAI 及 Gemini API，金鑰僅儲存在本機瀏覽器。</p>
  </header>

  <main class="max-w-4xl mx-auto px-4 space-y-6 pb-24">
    <div class="card">
      <h2 class="text-xl font-semibold mb-3">第一步：輸入你的 API Key</h2>
      
      <div class="mb-4">
        <label for="openaiApiKey" class="block text-sm font-medium text-gray-700 mb-1">OpenAI API Key (sk-)</label>
        <div class="flex gap-2 items-center">
          <input id="openaiApiKey" type="password" placeholder="sk-xxxxxxxxxxxxxxxx" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400">
          <button id="btnSaveOpenAIKey" class="btn btn-ghost">儲存</button>
          <button id="btnClearOpenAIKey" class="btn btn-ghost">清除</button>
        </div>
        <p id="openaiKeyHint" class="muted mt-1"></p>
      </div>

      <div>
        <label for="geminiApiKey" class="block text-sm font-medium text-gray-700 mb-1">Gemini API Key (AIza)</label>
        <div class="flex gap-2 items-center">
          <input id="geminiApiKey" type="password" placeholder="AIzaSyAxxxxxxxxxxxxxxxxx" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400">
          <button id="btnSaveGeminiKey" class="btn btn-ghost">儲存</button>
          <button id="btnClearGeminiKey" class="btn btn-ghost">清除</button>
        </div>
        <p id="geminiKeyHint" class="muted mt-1"></p>
      </div>
    </div>

    <div class="card">
      <h2 class="text-xl font-semibold mb-2">第二步：貼上文章或逐字稿</h2>
      <div class="flex items-center justify-between mb-2 text-sm">
        <div class="text-gray-700">建議字數：<span id="charLimit" class="font-semibold"></span> 字</div>
        <div class="text-gray-700">已輸入：<span id="charCount" class="font-semibold">0</span>／建議範圍內剩餘：<span id="charRemain" class="font-semibold">0</span></div>
      </div>
      <textarea id="inputText" rows="10" placeholder="請貼上逐字稿或文章內容...（注意：長文可能超出模型單次處理限制）" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400"></textarea>
      <p class="muted mt-2">提示：此版本不再有自動摘要功能。若內容過長，請自行精簡，以避免超出模型的 Token 限制導致生成失敗。</p>
    </div>

    <div class="card">
      <h2 class="text-xl font-semibold mb-3">第三步：選擇影片型態與模型</h2>
      <div class="space-y-2 mb-4">
        <label class="flex items-start gap-3 cursor-pointer">
          <input type="radio" name="mode" value="podcast" checked>
          <span><strong>Podcast 一鏡到底型：</strong>提供 5 段 45–75 秒重點片段</span>
        </label>
        <label class="flex items-start gap-3 cursor-pointer">
          <input type="radio" name="mode" value="topic">
          <span><strong>議題型：</strong>60 秒旁白腳本 + 建議畫面</span>
        </label>
        <label class="flex items-start gap-3 cursor-pointer">
          <input type="radio" name="mode" value="people">
          <span><strong>人物故事型：</strong>原音摘錄 + 旁白 + 畫面</span>
        </label>
      </div>

      <div class="flex flex-wrap items-center gap-4">
        <label class="text-sm text-gray-700">模型：</label>
        <select id="modelSelect" class="p-2 border border-gray-300 rounded-lg text-sm">
          <optgroup label="OpenAI (需要 sk- Key)">
            <option value="openai:gpt-4o-mini" selected>GPT-4o mini（建議）</option>
            <option value="openai:gpt-4o">GPT-4o（高階推理）</option>
            <option value="openai:gpt-3.5-turbo">GPT-3.5 Turbo（低成本）</option>
          </optgroup>
          <optgroup label="Google (需要 AIza Key)">
            <option value="gemini:gemini-2.5-flash">Gemini 2.5 Flash（高CP值、快速）</option>
            <option value="gemini:gemini-2.5-pro">Gemini 2.5 Pro（進階推理）</option>
          </optgroup>
        </select>
        <label class="flex items-center gap-2 text-sm ml-4 text-gray-500">
            <span>已移除「先摘要」功能，請自行精簡內容。</span>
        </label>
      </div>
      <p class="muted mt-2">OpenAI 使用 <code>/v1/chat/completions</code>；Gemini 使用 <code>/v1beta/models/...:generateContent</code> 端點。</p>
    </div>

    <div class="card">
      <h2 class="text-xl font-semibold mb-3">第四步：生成腳本</h2>
      <button id="btnGenerate" class="btn btn-primary" disabled>確認生成</button>
      <p id="sysMsg" class="text-sm text-gray-600 mt-3"></p>
    </div>

    <div class="card">
      <h2 class="text-xl font-semibold mb-3">結果：</h2>
      <div class="flex flex-wrap gap-2 mb-3">
        <button id="btnCopy" class="btn btn-ghost">複製</button>
        <button id="btnDownload" class="btn btn-ghost">下載 .txt</button>
      </div>
      <pre id="output" class="code">請輸入至少一個 API Key 並貼上文章以開始生成。</pre>
    </div>
  </main>

  <script>
  // === 配置參數 ===
  const INPUT_CHAR_LIMIT = 10000; 
  const USE_TIMEOUT_MS = 120_000; // 2分鐘超時

  // === 狀態儲存鍵值 ===
  const KEY_OPENAI = 'user_openai_key';
  const KEY_GEMINI = 'user_gemini_key';
  const MASK = '********';

  // === DOM 元素引用 ===
  const el = id => document.getElementById(id);
  
  const openaiKeyInput = el('openaiApiKey');
  const btnSaveOpenAIKey = el('btnSaveOpenAIKey');
  const btnClearOpenAIKey = el('btnClearOpenAIKey');
  const openaiKeyHint = el('openaiKeyHint');

  const geminiKeyInput = el('geminiApiKey');
  const btnSaveGeminiKey = el('btnSaveGeminiKey');
  const btnClearGeminiKey = el('btnClearGeminiKey');
  const geminiKeyHint = el('geminiKeyHint');
  
  const generateBtn = el('btnGenerate');
  const output = el('output');
  const sysMsg = el('sysMsg');
  const modelSelect = el('modelSelect');
  const inputText = el('inputText');
  const charLimit = el('charLimit');
  const charCount = el('charRemain').previousElementSibling; 
  const charRemain = el('charRemain');
  const modeRadios = document.querySelectorAll('input[name="mode"]');
  const controlElements = [generateBtn, modelSelect, inputText, ...modeRadios];

  // === 狀態初始化 ===
  let userOpenAIKey = localStorage.getItem(KEY_OPENAI) || '';
  let userGeminiKey = localStorage.getItem(KEY_GEMINI) || '';

  function loadKeys() {
    if (userOpenAIKey) {
      openaiKeyInput.value = MASK;
      openaiKeyHint.textContent = `✅ 已儲存 OpenAI Key：sk-****${userOpenAIKey.slice(-4)}`;
    } else {
      openaiKeyInput.value = '';
      openaiKeyHint.textContent = '請輸入 OpenAI Key';
    }

    if (userGeminiKey) {
      geminiKeyInput.value = MASK;
      geminiKeyHint.textContent = `✅ 已儲存 Gemini Key：AIza****${userGeminiKey.slice(-4)}`;
    } else {
      geminiKeyInput.value = '';
      geminiKeyHint.textContent = '請輸入 Gemini Key';
    }
  }

  loadKeys();
  charLimit.textContent = INPUT_CHAR_LIMIT.toLocaleString();
  updateCharCounter();
  updateGenerateButtonState();

  // === UI 控制：字數計數與按鈕狀態 ===
  function updateCharCounter() {
    const len = inputText.value.length;
    charCount.textContent = len.toLocaleString();
    const remain = INPUT_CHAR_LIMIT - len;

    charRemain.textContent = remain.toLocaleString();
    
    if (remain < 0) {
      charRemain.classList.add('warn');
    } else {
      charRemain.classList.remove('warn');
    }
    updateGenerateButtonState();
  }
  inputText.addEventListener('input', updateCharCounter);
  modelSelect.addEventListener('change', updateGenerateButtonState); // 模型變更時檢查是否有 Key
  
  function updateGenerateButtonState() {
    const [provider, modelName] = modelSelect.value.split(':');
    const hasInput = inputText.value.trim().length > 0;
    
    let hasKey = false;
    if (provider === 'openai') {
      hasKey = Boolean(userOpenAIKey);
    } else if (provider === 'gemini') {
      hasKey = Boolean(userGeminiKey);
    }

    generateBtn.disabled = !(hasKey && hasInput);

    if (!hasKey) {
      sysMsg.textContent = `請先儲存有效的 ${provider.toUpperCase()} API Key。`;
    } else {
      sysMsg.textContent = '已就緒，點擊確認生成。';
    }
  }

  function setControlsDisabled(disabled) {
    controlElements.forEach(el => el.disabled = disabled);
    openaiKeyInput.disabled = disabled; 
    btnSaveOpenAIKey.disabled = disabled;
    btnClearOpenAIKey.disabled = disabled;
    geminiKeyInput.disabled = disabled; 
    btnSaveGeminiKey.disabled = disabled;
    btnClearGeminiKey.disabled = disabled;
  }

  // === Key 處理邏輯 (OpenAI) ===
  btnSaveOpenAIKey.addEventListener('click', () => {
    const val = openaiKeyInput.value.trim();
    if (val === MASK && userOpenAIKey) {
        openaiKeyHint.textContent = `✅ 金鑰未變更：sk-****${userOpenAIKey.slice(-4)}（已儲存）`;
        return; 
    }
    // 支援 sk- 或 sk-proj- 開頭，並允許字母、數字、下劃線、連字符
    const API_KEY_REGEX = /^sk-(proj-)?[a-zA-Z0-9_-]{40,}$/;

    if (!API_KEY_REGEX.test(val)) {
      openaiKeyHint.innerHTML = '<span class="warn">格式錯誤（必須以 sk- 或 sk-proj- 開頭，且長度足夠）。</span>';
      return;
    }
    localStorage.setItem(KEY_OPENAI, val);
    userOpenAIKey = val;
    loadKeys(); // 重新載入 Key 狀態
    updateGenerateButtonState();
  });

  btnClearOpenAIKey.addEventListener('click', () => {
    localStorage.removeItem(KEY_OPENAI);
    userOpenAIKey = '';
    loadKeys();
    updateGenerateButtonState();
  });
  
  // === Key 處理邏輯 (Gemini) ===
  btnSaveGeminiKey.addEventListener('click', () => {
    const val = geminiKeyInput.value.trim();
    if (val === MASK && userGeminiKey) {
        geminiKeyHint.textContent = `✅ 金鑰未變更：AIza****${userGeminiKey.slice(-4)}（已儲存）`;
        return; 
    }
    // 檢查是否以 AIzaSy 開頭
    const API_KEY_REGEX = /^AIzaSy[a-zA-Z0-9_-]{35,}$/; 

    if (!API_KEY_REGEX.test(val)) {
      geminiKeyHint.innerHTML = '<span class="warn">格式錯誤（必須以 AIzaSy 開頭，且長度足夠）。</span>';
      return;
    }
    localStorage.setItem(KEY_GEMINI, val);
    userGeminiKey = val;
    loadKeys(); // 重新載入 Key 狀態
    updateGenerateButtonState();
  });

  btnClearGeminiKey.addEventListener('click', () => {
    localStorage.removeItem(KEY_GEMINI);
    userGeminiKey = '';
    loadKeys();
    updateGenerateButtonState();
  });


  // === 核心 API 呼叫函式 (支援 OpenAI/Gemini) ===
  async function callChatCompletions({ provider, modelName, prompt, signal }) {
    const MAX_RETRY = 3;
    let attempt = 0;
    let lastErr;
    let apiKey = provider === 'openai' ? userOpenAIKey : userGeminiKey;
    let systemMessageContent = '你是一個有幫助、專業的助理。';
    
    // 從提示詞中解析 System Message
    const promptLines = prompt.split('\n');
    if (promptLines[0].startsWith('你是')) {
        systemMessageContent = promptLines[0];
        prompt = promptLines.slice(1).join('\n').trim(); 
    }
    
    while (attempt < MAX_RETRY) {
      try {
        let url, headers, body;

        if (provider === 'openai') {
          url = 'https://api.openai.com/v1/chat/completions';
          headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
          };
          body = JSON.stringify({
            model: modelName,
            messages: [
              { role: 'system', content: systemMessageContent },
              { role: 'user', content: prompt }
            ], 
            temperature: 0.7,
            stream: false,
          });

        } else if (provider === 'gemini') {
          // Gemini API 呼叫結構
          url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
          headers = {
            'Content-Type': 'application/json',
          };
          body = JSON.stringify({
            contents: [
              { role: 'user', parts: [{ text: `${systemMessageContent}\n\n${prompt}` }] }
            ],
            config: {
                temperature: 0.7,
            }
          });
        }
        
        const res = await fetch(url, { method: 'POST', headers, body, signal });

        const raw = await res.text();
        let data;
        try { data = JSON.parse(raw); } catch { data = null; }

        if (!res.ok) {
          const msg = data?.error?.message || raw || `HTTP ${res.status}`;
          if (res.status === 429) { 
            const backoff = Math.min(2000 * (attempt + 1), 8000);
            await new Promise(r => setTimeout(r, backoff));
            attempt++;
            lastErr = new Error(`HTTP 429｜${msg}`);
            continue; 
          }
          throw new Error(`HTTP ${res.status} ${res.statusText}｜${msg}`);
        }

        let textOut = '';
        if (provider === 'openai') {
            textOut = data?.choices?.[0]?.message?.content || ''; 
        } else if (provider === 'gemini') {
            textOut = data?.candidates?.[0]?.content?.parts?.[0]?.text || 'Gemini 輸出內容為空，可能被安全過濾。';
            // 檢查是否被安全過濾
            if (!textOut && data?.promptFeedback?.safetyRatings) {
                 const filter = data.candidates?.[0]?.finishReason;
                 throw new Error(`Gemini 輸出被過濾 (${filter || 'Safety Filter'})`);
            }
        }
        return textOut;

      } catch (e) {
        if (e.name === 'AbortError') throw e;
        lastErr = e;
        const backoff = Math.min(1500 * (attempt + 1), 6000);
        await new Promise(r => setTimeout(r, backoff));
        attempt++; 
      }
    }
    throw lastErr || new Error('呼叫失敗，請檢查網路連線或稍後再試');
  }

  // === 任務：腳本提示詞 (使用字串模板) ===
  function buildScriptPrompt(mode, sourceText) {
    // 系統提示詞部分
    const base = `你是台灣中文內容製作的短影音腳本編劇，請用繁體中文撰寫 Markdown 格式輸出。`;
    let task = '';
    if (mode === 'podcast') task = '請選出 5 段 45–75 秒可一鏡到底的重點片段，附時間碼與重點，內容基於以下原文。';
    else if (mode === 'topic') task = '請寫出 60 秒議題型旁白腳本，附建議時間與畫面，內容基於以下原文。';
    else task = '請寫出 60 秒人物故事型腳本，包含原音摘錄、大意與建議畫面，內容基於以下原文。';
    
    return `${base}
${task}

【原文】
${sourceText}`;
  }

  // === 生成主流程 ===
  generateBtn.addEventListener('click', async () => {
    const raw = inputText.value.trim();
    if (!raw) {
        sysMsg.textContent = '請先貼上內容！';
        return;
    }
    
    const [provider, modelName] = modelSelect.value.split(':');
    let apiKeyUsed = provider === 'openai' ? userOpenAIKey : userGeminiKey;
    
    if (!apiKeyUsed) {
        sysMsg.textContent = `請先輸入你的 ${provider.toUpperCase()} API Key！`;
        return;
    }
    
    if (raw.length > INPUT_CHAR_LIMIT) {
        if (!confirm(`警告：您貼上的內容 (${raw.length} 字) 已超出建議限制 (${INPUT_CHAR_LIMIT} 字)。\n\n直接傳送給模型可能會因為 Token 數超限而失敗。確定要繼續嗎？`)) {
            sysMsg.textContent = '生成已取消。請精簡內容後再試。';
            return;
        }
    }

    setControlsDisabled(true); 
    output.textContent = '⏳ 正在生成中... (請耐心等待)';
    sysMsg.textContent = `使用 ${provider.toUpperCase()} (Model: ${modelName}) 撰寫腳本…`;
    
    const mode = document.querySelector('input[name="mode"]:checked')?.value || 'topic';
    
    const ac = new AbortController();
    const timeout = setTimeout(() => ac.abort(), USE_TIMEOUT_MS);

    try {
      const scriptPrompt = buildScriptPrompt(mode, raw);
      const result = await callChatCompletions({ provider, modelName, prompt: scriptPrompt, signal: ac.signal });

      output.textContent = result;
      sysMsg.textContent = '✅ 已完成';
    
    } catch (err) {
      if (err.name === 'AbortError') {
        output.textContent = '❌ 錯誤：操作超時，已終止請求。';
        sysMsg.textContent = '請求已超時（網路連線、內容過長或模型延遲）。';
      
      } else if (err.message.includes('HTTP 401')) {
        output.textContent = `❌ 錯誤：${provider.toUpperCase()} Key 無效或授權失敗 (HTTP 401)。`;
        sysMsg.textContent = `請檢查您的 ${provider.toUpperCase()} API Key 是否正確且有效。`;
      
      } else if (err.message.includes('HTTP 429')) {
        output.textContent = `❌ 錯誤：${err?.message || 'HTTP 429'}`;
        sysMsg.textContent = `錯誤：已達 ${provider.toUpperCase()} API 速率或額度上限 (Quota)。請登入該平台檢查您的帳單與付款設定。`;
      
      } else if (err.message.includes('400') && err.message.includes('maximum context length')) {
        output.textContent = `❌ 錯誤：輸入內容過長，超過模型最大 Token 限制。`;
        sysMsg.textContent = '請精簡您的文章內容後再試。';
      
      } else {
        output.textContent = `❌ 錯誤：${err?.message || err.toString()}`;
        sysMsg.textContent = `發生錯誤（請檢查 Key、用量或主控台）。`;
      }
      console.error(err);
    
    } finally {
      clearTimeout(timeout);
      setControlsDisabled(false);
      updateGenerateButtonState();
    }
  });

  // === 複製 / 下載 ===
  el('btnCopy').addEventListener('click', async () => {
    const text = output.textContent;
    if (!text || text.startsWith('❌ 錯誤')) {
        sysMsg.textContent = '請先生成有效的內容。';
        return;
    }
    try {
        await navigator.clipboard.writeText(text);
        sysMsg.textContent = '✅ 已複製到剪貼簿';
    } catch (error) {
        sysMsg.textContent = '❌ 複製失敗，瀏覽器權限不足。';
    }
  });

  el('btnDownload').addEventListener('click', () => {
    const text = output.textContent;
    if (!text || text.startsWith('❌ 錯誤')) {
        sysMsg.textContent = '請先生成有效的內容。';
        return;
    }
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = '短影音腳本.txt';
    a.click();
  });
  </script>
</body>
</html>
