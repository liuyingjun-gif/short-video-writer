<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>çŸ­å½±éŸ³è…³æœ¬ç”Ÿæˆå™¨</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* åŸºæœ¬æ¨£å¼èˆ‡è—è‰²èª¿å„ªåŒ– */
    body { font-family: 'Inter', sans-serif; background: #f0f3f8; color: #111827; } /* æ·ºè—ç°è‰²åº•è‰² */
    .card { 
        background: white; 
        border-radius: 1.25rem; /* ç¨å¾®æ›´åœ“æ½¤ */
        box-shadow: 0 10px 30px rgba(0,0,0,.08); /* æ›´æ˜é¡¯çš„é™°å½± */
        padding: 2rem; /* å¢åŠ å…§é‚Šè· */
        border: 1px solid #e5e7eb; /* è¼•å¾®é‚Šæ¡† */
    }
    
    /* æŒ‰éˆ•æ¨£å¼ */
    .btn { border-radius: 9999px; padding: .6rem 1.5rem; font-weight: 600; transition: all 0.2s; }
    .btn-primary { 
        background: #0284c7; 
        color: #fff; 
        box-shadow: 0 4px 10px rgba(2, 132, 199, 0.4);
    }
    .btn-primary:hover:not(:disabled) { background: #0369a1; box-shadow: 0 6px 15px rgba(2, 132, 199, 0.5); }
    .btn-ghost { background: #eef2ff; color: #0284c7; border: 1px solid #c7d2fe; } /* æ·ºè—è‰²ç³»æŒ‰éˆ• */
    .btn-ghost:hover:not(:disabled) { background: #dbeafe; } /* æ‡¸åœæ™‚æ›´æ·±çš„è—è‰² */
    
    /* ç¦ç”¨ç‹€æ…‹ */
    .btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }

    /* ç¨‹å¼ç¢¼èˆ‡æç¤ºæ¨£å¼ */
    .code { 
      background: #0f172a; 
      color: #e2e8f0; 
      border-radius: .75rem; 
      padding: 1.5rem;  /* å¢åŠ å…§é‚Šè· */
      overflow: auto; 
      font-size: 0.875rem;
    }
    .muted { color:#6b7280; font-size:12px }
    .warn { color:#dc2626; font-weight: 700; } 
    .input-style {
        padding: 0.75rem;
        border: 1px solid #cbd5e1;
        border-radius: 0.75rem;
        transition: border-color 0.2s;
    }
    .input-style:focus {
        border-color: #0284c7;
        outline: none;
        box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.2);
    }
    
    /* è¡¨æ ¼æ¨£å¼ï¼Œä½¿å…¶åœ¨ .code (æ·±è‰²èƒŒæ™¯) ä¸­å¯è®€ */
    .markdown-output table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
    }
    .markdown-output th, 
    .markdown-output td {
        border: 1px solid #374151; /* ç°è‰²é‚Šæ¡† */
        padding: 0.5rem 0.75rem;
        text-align: left;
    }
    .markdown-output th {
        background-color: #1f2937; /* è¡¨é ­æ·±è‰² */
    }
    .markdown-output tr:nth-child(even) {
        background-color: #11182a; /* æ–‘é¦¬ç´‹ */
    }
    .markdown-output h1,
    .markdown-output h2,
    .markdown-output h3 {
        font-weight: 600;
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>
  <header class="bg-white shadow-sm">
    <div class="max-w-4xl mx-auto px-4 py-8">
      <h1 class="text-4xl font-extrabold mb-2 text-sky-700">çŸ­å½±éŸ³è…³æœ¬ç”Ÿæˆå™¨ ğŸ¬</h1>
      <p class="text-gray-600">æ­¤ç‰ˆæœ¬æ”¯æ´ OpenAI åŠ Gemini APIï¼Œé‡‘é‘°åƒ…å„²å­˜åœ¨æœ¬æ©Ÿç€è¦½å™¨ã€‚</p>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 space-y-8 pt-10 pb-24">
    <div class="card">
      <h2 class="text-2xl font-semibold mb-4 text-gray-800">ç¬¬ä¸€æ­¥ï¼šè¼¸å…¥ä½ çš„ API Key</h2>
      
      <p class="text-gray-600 mb-6">è«‹å¡«å¯«è‡³å°‘ä¸€å€‹ API Keyã€‚</p>

      <div>
        <label for="openaiApiKey" class="block text-sm font-medium text-gray-700 mb-2">OpenAI API Key (sk-)</label>
        <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
          <input id="openaiApiKey" type="password" placeholder="sk-xxxxxxxxxxxxxxxx" class="flex-1 input-style">
          <div class="flex gap-3">
            <button id="btnSaveOpenAIKey" class="btn btn-ghost flex-1 sm:flex-auto">å„²å­˜</button>
            <button id="btnClearOpenAIKey" class="btn btn-ghost flex-1 sm:flex-auto">æ¸…é™¤</button>
          </div>
        </div>
        <p id="openaiKeyHint" class="muted mt-2"></p>
      </div>

      <div class="pt-5 mt-5 border-t border-gray-200">
        <label for="geminiApiKey" class="block text-sm font-medium text-gray-700 mb-2">Gemini API Key (AIza)</label>
        <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
          <input id="geminiApiKey" type="password" placeholder="AIzaSyAxxxxxxxxxxxxxxxxx" class="flex-1 input-style">
          <div class="flex gap-3">
            <button id="btnSaveGeminiKey" class="btn btn-ghost flex-1 sm:flex-auto">å„²å­˜</button>
            <button id="btnClearGeminiKey" class="btn btn-ghost flex-1 sm:flex-auto">æ¸…é™¤</button>
          </div>
        </div>
        <p id="geminiKeyHint" class="muted mt-2"></p>
      </div>
    </div>

    <div class="card">
      <h2 class="text-2xl font-semibold mb-4 text-gray-800">ç¬¬äºŒæ­¥ï¼šè²¼ä¸Šæ–‡ç« æˆ–é€å­—ç¨¿</h2>
      
      <div class="mb-4">
        <label for="fileUpload" class="block text-sm font-medium text-gray-700 mb-2">æˆ–ä¸Šå‚³ .txt / .srt æª”æ¡ˆï¼š</label>
        <input type="file" id="fileUpload" accept=".txt,.srt" class="block w-full text-sm text-gray-500
          file:mr-4 file:py-2 file:px-4
          file:rounded-full file:border-0
          file:text-sm file:font-semibold
          file:bg-sky-50 file:text-sky-700
          hover:file:bg-sky-100
          cursor-pointer
        ">
        <p id="fileUploadHint" class="muted mt-2"></p>
      </div>

      <div class="flex items-center justify-between mb-3 text-sm">
        <div class="text-gray-700">å»ºè­°å­—æ•¸ï¼š<span id="charLimit" class="font-semibold text-sky-600"></span> å­—</div>
        <div class="text-gray-700">å·²è¼¸å…¥ (ä¸å«ç©ºè¡Œ)ï¼š<span id="charCount" class="font-semibold text-sky-600">0</span>ï¼å»ºè­°ç¯„åœå…§å‰©é¤˜ï¼š<span id="charRemain" class="font-semibold text-sky-600">0</span></div>
      </div>
      <textarea id="inputText" rows="10" placeholder="è«‹è²¼ä¸Šé€å­—ç¨¿ã€æ–‡ç« å…§å®¹ï¼Œæˆ–å¾ä¸Šæ–¹ä¸Šå‚³æª”æ¡ˆ...ï¼ˆæ³¨æ„ï¼šé•·æ–‡å¯èƒ½è¶…å‡ºæ¨¡å‹å–®æ¬¡è™•ç†é™åˆ¶ï¼‰" class="w-full input-style"></textarea>
      <p class="muted mt-2">æç¤ºï¼šè‹¥å…§å®¹éé•·ï¼Œè«‹è‡ªè¡Œç²¾ç°¡ï¼Œä»¥é¿å…è¶…å‡ºæ¨¡å‹çš„ Token é™åˆ¶å°è‡´ç”Ÿæˆå¤±æ•—ã€‚</p>
    </div>

    <div class="card">
      <h2 class="text-2xl font-semibold mb-4 text-gray-800">ç¬¬ä¸‰æ­¥ï¼šé¸æ“‡å½±ç‰‡å‹æ…‹èˆ‡æ¨¡å‹</h2>
      
            <div class="space-y-3 mb-6 p-5 bg-sky-50 rounded-lg border border-sky-100">
        <label class="flex items-start gap-3 cursor-pointer">
          <input type="radio" name="mode" value="podcast" class="mt-1 accent-sky-600">
          <span><strong>Podcast ä¸€é¡åˆ°åº•å‹ï¼š</strong>æä¾› 5 æ®µ 45â€“75 ç§’é‡é»ç‰‡æ®µ</span>
        </label>
        <label class="flex items-start gap-3 cursor-pointer">
          <input type="radio" name="mode" value="topic" checked class="mt-1 accent-sky-600">
          <span><strong>è­°é¡Œå‹ï¼š</strong>3 æ®µ 45â€“75 ç§’æ—ç™½è…³æœ¬ + å»ºè­°ç•«é¢</span>
        </label>
        <label class="flex items-start gap-3 cursor-pointer">
          <input type="radio" name="mode" value="people" class="mt-1 accent-sky-600">
          <span><strong>äººç‰©æ•…äº‹å‹ï¼šï¼š</strong>3 æ®µ 45â€“75 ç§’åŸéŸ³æ‘˜éŒ„ + æ—ç™½ + ç•«é¢</span>
        </label>
      </div>

            <div class="flex flex-col sm:flex-row gap-4 mb-6 p-5 bg-indigo-50 rounded-lg border border-indigo-100">
        <div class="flex-1">
          <label for="targetAudience" class="block text-sm font-medium text-gray-700 mb-2">ç›®æ¨™å—çœ¾ï¼š</label>
          <select id="targetAudience" class="input-style text-sm w-full">
            <option value="ä¸€èˆ¬å¤§çœ¾" selected>ä¸€èˆ¬å¤§çœ¾ (é è¨­)</option>
            <option value="å­¸ç”Ÿ/é’å°‘å¹´">å­¸ç”Ÿ/é’å°‘å¹´ (å£èªåŒ–ã€è²¼è¿‘ç”Ÿæ´»)</option>
            <option value="è€å¸«/æ•™è‚²å·¥ä½œè€…">è€å¸«/æ•™è‚²å·¥ä½œè€… (çµæ§‹åŒ–ã€å°ˆæ¥­)</option>
            <option value="å®¶é•·/è¦ªå­é—œä¿‚">å®¶é•·/è¦ªå­é—œä¿‚ (æƒ…æ„Ÿã€å¯¦ç”¨å»ºè­°ç­‰)</option>
            <option value="å•†æ¥­äººå£«/å°ˆæ¥­é ˜åŸŸ">å•†æ¥­äººå£«/å°ˆæ¥­é ˜åŸŸ (ç²¾æº–ã€å•†æ¥­åŒ–)</option>
          </select>
        </div>
        <div class="flex-1">
          <label for="scriptTone" class="block text-sm font-medium text-gray-700 mb-2">è…³æœ¬èªæ°£/é¢¨æ ¼ï¼š</label>
          <select id="scriptTone" class="input-style text-sm w-full">
            <option value="ä¸­æ€§å°ˆæ¥­" selected>ä¸­æ€§å°ˆæ¥­ (é è¨­)</option>
            <option value="ç†±æƒ…æœ‰è¶£">ç†±æƒ…æœ‰è¶£ (æ´»æ½‘ã€å¹½é»˜)</option>
            <option value="æ·±åº¦æ„Ÿäºº">æ·±åº¦æ„Ÿäºº (æƒ…æ„Ÿã€å•Ÿç™¼)</option>
            <option value="æ–°èå ±å°">æ–°èå ±å° (å®¢è§€ã€å³æ™‚)</option>
            <option value="è³‡è¨Šæ•´ç†">è³‡è¨Šæ•´ç† (æ¢åˆ—å¼ã€é‚è¼¯æ¸…æ™°)</option>
          </select>
        </div>
      </div>
            <div class="flex flex-wrap items-center gap-4 pt-5 mt-5 border-t border-gray-200">
        <label class="text-sm text-gray-700 font-medium">é¸æ“‡æ¨¡å‹ï¼š</label>
        <select id="modelSelect" class="input-style text-sm">
          <optgroup label="OpenAI (éœ€è¦ sk- Key)">
            <option value="openai:gpt-4o-mini" selected>GPT-4o miniï¼ˆå»ºè­°ï¼‰</option> 
            <option value="openai:gpt-4o">GPT-4oï¼ˆé«˜éšæ¨ç†ï¼‰</option>
            <option value="openai:gpt-3.5-turbo">GPT-3.5 Turboï¼ˆä½æˆæœ¬ï¼‰</option>
          </optgroup>
          <optgroup label="Google (éœ€è¦ AIza Key)">
            <option value="gemini:gemini-2.5-flash">Gemini 2.5 Flashï¼ˆé«˜CPå€¼ã€å¿«é€Ÿï¼‰</option>
            <option value="gemini:gemini-2.5-pro">Gemini 2.5 Proï¼ˆé€²éšæ¨ç†ï¼‰</option>
          </optgroup>
        </select>
      </div>
      <p class="muted mt-3">è«‹é¸æ“‡èˆ‡æ‚¨æ‰€å¡«å¯« API Key ç›¸ç¬¦çš„æ¨¡å‹ã€‚</p>
    </div>

    <div class="card">
      <h2 class="text-2xl font-semibold mb-4 text-gray-800">ç¬¬å››æ­¥ï¼šç”Ÿæˆè…³æœ¬</h2>
      <button id="btnGenerate" class="btn btn-primary" disabled>ç¢ºèªç”Ÿæˆ</button>
      <p id="sysMsg" class="text-sm text-gray-600 mt-4"></p>
    </div>

    <div class="card">
      <h2 class="text-2xl font-semibold mb-4 text-gray-800">çµæœï¼š</h2>
      <div class="flex flex-col sm:flex-row gap-3 mb-4">
        <button id="btnCopy" class="btn btn-ghost">è¤‡è£½çµæœ</button>
        <button id="btnDownload" class="btn btn-ghost">ä¸‹è¼‰ .txt</button>
      </div>
      <p id="copyMsg" class="text-sm text-gray-600 mb-4 h-5"></p>
      
      <div id="output" class="code markdown-output" style="min-height: 100px; white-space: normal;">è«‹è¼¸å…¥è‡³å°‘ä¸€å€‹ API Key ä¸¦è²¼ä¸Šæ–‡ç« ä»¥é–‹å§‹ç”Ÿæˆã€‚</div>
    </div>
  </main>

  <script>
  // === é…ç½®åƒæ•¸ ===
  // å­—æ•¸é™åˆ¶æ”¹ç‚º 60000
  const INPUT_CHAR_LIMIT = 60000; 
  const USE_TIMEOUT_MS = 120_000; // 2åˆ†é˜è¶…æ™‚

  // === ç‹€æ…‹å„²å­˜éµå€¼ ===
  const KEY_OPENAI = 'user_openai_key';
  const KEY_GEMINI = 'user_gemini_key';
  const MASK = '********';

  // === DOM å…ƒç´ å¼•ç”¨ ===
  const el = id => document.getElementById(id);
  
  const openaiKeyInput = el('openaiApiKey');
  const btnSaveOpenAIKey = el('btnSaveOpenAIKey');
  const btnClearOpenAIKey = el('btnClearOpenAIKey');
  const openaiKeyHint = el('openaiKeyHint');

  const geminiKeyInput = el('geminiApiKey');
  const btnSaveGeminiKey = el('btnSaveGeminiKey');
  const btnClearGeminiKey = el('btnClearGeminiKey');
  const geminiKeyHint = el('geminiKeyHint');
  
  const generateBtn = el('btnGenerate');
  const output = el('output');
  const sysMsg = el('sysMsg');
  const copyMsg = el('copyMsg'); 
  
  const modelSelect = el('modelSelect');
  const inputText = el('inputText');
  const charLimit = el('charLimit');
  const charCount = el('charRemain').previousElementSibling; 
  const charRemain = el('charRemain');
  const modeRadios = document.querySelectorAll('input[name="mode"]');

  // ã€æ–°å¢ã€‘é€²éšé¸é …çš„ DOM å¼•ç”¨
  const targetAudience = el('targetAudience');
  const scriptTone = el('scriptTone');

  const fileUpload = el('fileUpload');
  const fileUploadHint = el('fileUploadHint');

  const controlElements = [generateBtn, modelSelect, inputText, ...modeRadios, targetAudience, scriptTone]; // æ›´æ–°æ§åˆ¶å…ƒç´ åˆ—è¡¨

  // === ç‹€æ…‹åˆå§‹åŒ– ===
  let userOpenAIKey = localStorage.getItem(KEY_OPENAI) || '';
  let userGeminiKey = localStorage.getItem(KEY_GEMINI) || '';

  function loadKeys() {
    if (userOpenAIKey) {
      openaiKeyInput.value = MASK;
      openaiKeyHint.textContent = `âœ… å·²å„²å­˜ OpenAI Keyï¼šsk-****${userOpenAIKey.slice(-4)}`;
    } else {
      openaiKeyInput.value = '';
      openaiKeyHint.textContent = 'è«‹è¼¸å…¥ OpenAI Key';
    }

    if (userGeminiKey) {
      geminiKeyInput.value = MASK;
      geminiKeyHint.textContent = `âœ… å·²å„²å­˜ Gemini Keyï¼šAIza****${userGeminiKey.slice(-4)}`;
    } else {
      geminiKeyInput.value = '';
      geminiKeyHint.textContent = 'è«‹è¼¸å…¥ Gemini Key';
    }
  }

  loadKeys();
  charLimit.textContent = INPUT_CHAR_LIMIT.toLocaleString();
  updateCharCounter();
  updateGenerateButtonState();
  
  // === çµæœå€æç¤ºè©å°å¹«æ‰‹ ===
  function showCopyMessage(message, isError = false) {
    copyMsg.textContent = message;
    if (isError) {
        copyMsg.className = 'text-sm text-red-600 mb-4 h-5';
    } else if (message === '') { // æ¸…é™¤
        copyMsg.className = 'text-sm text-gray-600 mb-4 h-5';
    } else { // æˆåŠŸ
        copyMsg.className = 'text-sm text-green-600 mb-4 h-5'; 
    }
  }

  // === UI æ§åˆ¶ï¼šå­—æ•¸è¨ˆæ•¸èˆ‡æŒ‰éˆ•ç‹€æ…‹ ===
  function updateCharCounter() {
    // æ›´æ–°å­—æ•¸è¨ˆç®—é‚è¼¯ï¼Œç§»é™¤ç©ºè¡Œ
    const rawText = inputText.value;
    const processedText = rawText.replace(/^\s*[\r\n]/gm, ''); // ç§»é™¤ç©ºè¡Œ
    const len = processedText.length;
    
    charCount.textContent = len.toLocaleString();
    const remain = INPUT_CHAR_LIMIT - len;

    charRemain.textContent = remain.toLocaleString();
    
    if (remain < 0) {
      charRemain.classList.add('warn');
    } else {
      charRemain.classList.remove('warn');
    }
    updateGenerateButtonState();
  }
  inputText.addEventListener('input', updateCharCounter);
  modelSelect.addEventListener('change', updateGenerateButtonState); 
  
  function updateGenerateButtonState() {
    const [provider, modelName] = modelSelect.value.split(':');
    
    // æª¢æŸ¥è¼¸å…¥æ™‚ä¹Ÿä½¿ç”¨ "ä¸å«ç©ºè¡Œ" çš„æ¨™æº–
    const hasInput = inputText.value.replace(/^\s*[\r\n]/gm, '').trim().length > 0;
    
    let hasKey = false;
    if (provider === 'openai') {
      hasKey = Boolean(userOpenAIKey);
    } 
    else if (provider === 'gemini') {
      hasKey = Boolean(userGeminiKey);
    }

    generateBtn.disabled = !(hasKey && hasInput);

    if (!hasKey) {
      sysMsg.textContent = `è«‹å…ˆå„²å­˜æœ‰æ•ˆçš„ ${provider.toUpperCase()} API Keyï¼Œæ‰èƒ½ä½¿ç”¨ ${modelName} æ¨¡å‹ã€‚`;
    } else {
      sysMsg.textContent = 'å·²å°±ç·’ï¼Œé»æ“Šç¢ºèªç”Ÿæˆã€‚';
    }
  }

  function setControlsDisabled(disabled) {
    controlElements.forEach(el => el.disabled = disabled);
    openaiKeyInput.disabled = disabled; 
    btnSaveOpenAIKey.disabled = disabled;
    btnClearOpenAIKey.disabled = disabled;
    geminiKeyInput.disabled = disabled; 
    btnSaveGeminiKey.disabled = disabled;
    btnClearGeminiKey.disabled = disabled;
    fileUpload.disabled = disabled; // ç¦ç”¨æª”æ¡ˆä¸Šå‚³
  }

  // === Key è™•ç†é‚è¼¯ (OpenAI) ===
  btnSaveOpenAIKey.addEventListener('click', () => {
    const rawVal = openaiKeyInput.value;
    const val = rawVal.replace(/\s/g, '').trim(); 

    if (val === MASK && userOpenAIKey) {
        openaiKeyHint.textContent = `âœ… é‡‘é‘°æœªè®Šæ›´ï¼šsk-****${userOpenAIKey.slice(-4)}ï¼ˆå·²å„²å­˜ï¼‰`;
        return; 
    }
    const API_KEY_REGEX = /^sk-(proj-)?[a-zA-Z0-9_-]{40,}$/;
    if (!API_KEY_REGEX.test(val)) {
      openaiKeyHint.innerHTML = '<span class="warn">æ ¼å¼éŒ¯èª¤ï¼ˆå¿…é ˆä»¥ sk- æˆ– sk-proj- é–‹é ­ï¼Œä¸”é•·åº¦è¶³å¤ ï¼‰ã€‚</span>';
      return;
    }
    localStorage.setItem(KEY_OPENAI, val);
    userOpenAIKey = val;
    loadKeys(); 
    updateGenerateButtonState();
  });

  btnClearOpenAIKey.addEventListener('click', () => {
    localStorage.removeItem(KEY_OPENAI);
    userOpenAIKey = '';
    loadKeys();
    updateGenerateButtonState();
  });
  
  // === Key è™•ç†é‚è¼¯ (Gemini) ===
  btnSaveGeminiKey.addEventListener('click', () => {
    const rawVal = geminiKeyInput.value;
    const val = rawVal.replace(/\s/g, '').trim(); 

    if (val === MASK && userGeminiKey) {
        geminiKeyHint.textContent = `âœ… é‡‘é‘°æœªè®Šæ›´ï¼šAIza****${userGeminiKey.slice(-4)}ï¼ˆå·²å„²å­˜ï¼‰`;
        return; 
    }
    const API_KEY_REGEX = /^AIzaSy[a-zA-Z0-9_-]{33,45}$/; 
    if (!API_KEY_REGEX.test(val)) {
      geminiKeyHint.innerHTML = '<span class="warn">æ ¼å¼éŒ¯èª¤ï¼ˆå¿…é ˆä»¥ AIzaSy é–‹é ­ï¼Œä¸”é•·åº¦è¶³å¤ ï¼Œç´„ 39-49 å€‹å­—å…ƒï¼‰ã€‚</span>';
      return;
    }
    localStorage.setItem(KEY_GEMINI, val);
    userGeminiKey = val;
    loadKeys(); 
    updateGenerateButtonState();
  });

  btnClearGeminiKey.addEventListener('click', () => {
    localStorage.removeItem(KEY_GEMINI);
    userGeminiKey = '';
    loadKeys();
    updateGenerateButtonState();
  });

  // === æª”æ¡ˆä¸Šå‚³è™•ç† ===
  function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) {
      fileUploadHint.textContent = '';
      return;
    }
    
    // å†æ¬¡æª¢æŸ¥ (é›–ç„¶ accept å±¬æ€§æœ‰å¹«åŠ©)
    const isTxt = file.type === 'text/plain';
    const isSrt = file.name.toLowerCase().endsWith('.srt');
    
    if (!isTxt && !isSrt) {
      fileUploadHint.textContent = 'âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œåƒ…æ”¯æ´ .txt èˆ‡ .srt';
      fileUploadHint.classList.add('warn');
      event.target.value = null; // æ¸…é™¤ input
      return;
    }

    const reader = new FileReader();

    reader.onload = (e) => {
      try {
        const text = e.target.result;
        inputText.value = text;
        // æ‰‹å‹•è§¸ç™¼ input äº‹ä»¶ï¼Œä»¥æ›´æ–°å­—æ•¸çµ±è¨ˆå’ŒæŒ‰éˆ•ç‹€æ…‹
        inputText.dispatchEvent(new Event('input', { bubbles: true }));
        fileUploadHint.textContent = `âœ… å·²è¼‰å…¥æª”æ¡ˆï¼š${file.name} (${file.size.toLocaleString()} bytes)`;
        fileUploadHint.classList.remove('warn');
      } catch (readError) {
          fileUploadHint.textContent = `âŒ è®€å–æª”æ¡ˆå…§å®¹æ™‚ç™¼ç”ŸéŒ¯èª¤: ${readError.message}`;
          fileUploadHint.classList.add('warn');
      }
    };

    reader.onerror = () => {
      fileUploadHint.textContent = 'âŒ è®€å–æª”æ¡ˆå¤±æ•—ã€‚è«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™ã€‚';
      fileUploadHint.classList.add('warn');
    };

    // é è¨­ä½¿ç”¨ UTF-8 è®€å–ï¼Œé€™å° .srt å’Œå¤šæ•¸ .txt æ ¼å¼æ˜¯æ¨™æº–çš„
    // æ³¨æ„ï¼šè‹¥ä½¿ç”¨è€…ä¸Šå‚³ Big5 ç·¨ç¢¼çš„ .txtï¼Œé€™è£¡è®€å–æœƒæ˜¯äº‚ç¢¼ã€‚
    reader.readAsText(file, 'UTF-8');
    
    // æ¸…ç©º input value è®“ä½¿ç”¨è€…å¯ä»¥é‡è¦†ä¸Šå‚³åŒä¸€å€‹æª”æ¡ˆ
    event.target.value = null;
  }
  fileUpload.addEventListener('change', handleFileUpload);


  // === æ ¸å¿ƒ API å‘¼å«å‡½å¼ (æ”¯æ´ OpenAI/Gemini) ===
  async function callChatCompletions({ provider, modelName, prompt, signal }) {
    const MAX_RETRY = 3;
    let attempt = 0;
    let lastErr;
    let apiKey = provider === 'openai' ? userOpenAIKey : userGeminiKey;
    let systemMessageContent = 'ä½ æ˜¯ä¸€å€‹æœ‰å¹«åŠ©ã€å°ˆæ¥­çš„åŠ©ç†ã€‚';
    
    // å¾æç¤ºè©ä¸­è§£æ System Message
    const promptLines = prompt.split('\n');
    if (promptLines[0].startsWith('ä½ æ˜¯')) {
        systemMessageContent = promptLines[0];
        prompt = promptLines.slice(1).join('\n').trim(); 
    }
    
    while (attempt < MAX_RETRY) {
      try {
        let url, headers, body;

        if (provider === 'openai') {
          url = 'https://api.openai.com/v1/chat/completions';
          headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
          };
          body = JSON.stringify({
            model: modelName,
            messages: [
              { role: 'system', content: systemMessageContent },
              { role: 'user', content: prompt }
            ], 
            temperature: 0.7,
            stream: false,
          });

        } else if (provider === 'gemini') {
          url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
          headers = {
            'Content-Type': 'application/json',
          };
          body = JSON.stringify({
            contents: [
              { role: 'user', parts: [{ text: `${systemMessageContent}\n\n${prompt}` }] }
            ],
            generationConfig: {
                temperature: 0.7,
            }
          });
        }
        
        const res = await fetch(url, { method: 'POST', headers, body, signal });
        const raw = await res.text();
        let data;
        try { data = JSON.parse(raw); } catch { data = null; }

        if (!res.ok) {
          const msg = data?.error?.message || raw || `HTTP ${res.status}`;
          if (res.status === 429) { 
            const backoff = Math.min(2000 * (attempt + 1), 8000);
            await new Promise(r => setTimeout(r, backoff));
            attempt++;
            lastErr = new Error(`HTTP 429ï½œ${msg}`);
            continue; 
          }
          throw new Error(`HTTP ${res.status} ${res.statusText}ï½œ${msg}`);
        }

        let textOut = '';
        if (provider === 'openai') {
            textOut = data?.choices?.[0]?.message?.content || ''; 
        } else if (provider === 'gemini') {
            textOut = data?.candidates?.[0]?.content?.parts?.[0]?.text || 'Gemini è¼¸å‡ºå…§å®¹ç‚ºç©ºï¼Œå¯èƒ½è¢«å®‰å…¨éæ¿¾ã€‚';
            if (!textOut && data?.candidates?.[0]?.finishReason === 'SAFETY') {
                 throw new Error(`Gemini è¼¸å‡ºè¢«å…§å®¹å®‰å…¨éæ¿¾ (SAFETY)`);
            }
            if (!textOut && data?.error) {
                 throw new Error(`Gemini API éŒ¯èª¤: ${data.error.message}`);
            }
        }
        return textOut;

      } catch (e) {
        if (e.name === 'AbortError') throw e;
        lastErr = e;
        const backoff = Math.min(1500 * (attempt + 1), 6000);
        await new Promise(r => setTimeout(r, backoff));
        attempt++; 
      }
    }
    throw lastErr || new Error('å‘¼å«å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦');
  }

  // === æ›´æ–°ä»»å‹™è…³æœ¬ä»¥ç´å…¥é€²éšé¸é … ===
  function buildScriptPrompt(mode, sourceText) {
    // 1. å–å¾—é€²éšé¸é …çš„å€¼
    const audience = targetAudience.value;
    const tone = scriptTone.value;

    // 2. è¨­å®šåŸºç¤æç¤ºè© (System Message)
    let base = `ä½ æ˜¯ä¸€å€‹å°ˆé–€å”åŠ©æ•¸ä½å½±éŸ³ä¼åŠƒçš„åŠ©ç†ï¼Œä½¿ç”¨è€…çš„ä¸»è¦å°è±¡æ˜¯å½±éŸ³ç·¨è¼¯èˆ‡ä¼åŠƒåŒäº‹ã€‚ç›®æ¨™æ˜¯æ¥æ”¶ä½¿ç”¨è€…æä¾›çš„æ–‡å­—å…§å®¹æˆ–æª”æ¡ˆï¼Œæ ¹æ“šä¸åŒéœ€æ±‚å¿«é€Ÿç”¢å‡ºå°æ‡‰çš„æˆå“ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡æ’°å¯«ã€‚è«‹å„ªå…ˆä½¿ç”¨ Markdown è¡¨æ ¼ (table) æ ¼å¼ä¾†çµ„ç¹”ä½ çš„è¼¸å‡ºå…§å®¹ã€‚`;
    
    // 3. æ ¹æ“šå½±ç‰‡å‹æ…‹èª¿æ•´ä»»å‹™
    let task = '';
    if (mode === 'podcast') task = 'è«‹é¸å‡º 5 æ®µ 45â€“75 ç§’å¯ä¸€é¡åˆ°åº•çš„é‡é»ç‰‡æ®µï¼Œé™„æ™‚é–“ç¢¼èˆ‡é‡é»ã€‚';
    else if (mode === 'topic') task = 'è«‹å¯«å‡º 3 æ®µ 45â€“75 ç§’è­°é¡Œå‹æ—ç™½è…³æœ¬ + å»ºè­°ç•«é¢ã€‚';
    else task = 'è«‹å¯«å‡º 3 æ®µ 45â€“75 ç§’äººç‰©æ•…äº‹å‹è…³æœ¬ï¼ŒåŒ…å«åŸéŸ³æ‘˜éŒ„ã€å¤§æ„èˆ‡å»ºè­°ç•«é¢ã€‚';
    
    // 4. æ•´åˆé€²éšé¸é …åˆ°ä»»å‹™ä¸­
    const instruction = `è«‹æ ¹æ“šä»¥ä¸‹ã€åŸæ–‡ã€‘å…§å®¹ï¼Œå®Œæˆä¸Šè¿°ä»»å‹™ã€‚åŒæ™‚ï¼Œ**è«‹ç¢ºä¿è…³æœ¬æ˜¯ç‚ºã€ç›®æ¨™å—çœ¾: ${audience}ã€‘æ’°å¯«ï¼Œä¸¦ä½¿ç”¨ã€èªæ°£/é¢¨æ ¼: ${tone}ã€‘ä¾†å‘ˆç¾ã€‚**`;

    return `${base}
${task}
${instruction}

ã€åŸæ–‡ã€‘
${sourceText}`;
  }

  // === ç”Ÿæˆä¸»æµç¨‹ (ä¸è®Š) ===
  generateBtn.addEventListener('click', async () => {
    showCopyMessage('', false); 
  
    const raw = inputText.value;
    const processedRaw = raw.replace(/^\s*[\r\n]/gm, '').trim(); 
    
    if (!processedRaw) {
        sysMsg.textContent = 'è«‹å…ˆè²¼ä¸Šå…§å®¹ï¼';
        return;
    }
    
    const [provider, modelName] = modelSelect.value.split(':');
    let apiKeyUsed = provider === 'openai' ? userOpenAIKey : userGeminiKey;
    
    if (!apiKeyUsed) {
        sysMsg.textContent = `è«‹å…ˆè¼¸å…¥ä½ çš„ ${provider.toUpperCase()} API Keyï¼`;
        return;
    }
    
    if (processedRaw.length > INPUT_CHAR_LIMIT) {
        if (!confirm(`è­¦å‘Šï¼šæ‚¨è²¼ä¸Šçš„å…§å®¹ (${processedRaw.length} å­—) å·²è¶…å‡ºå»ºè­°é™åˆ¶ (${INPUT_CHAR_LIMIT} å­—)ã€‚\n\nç›´æ¥å‚³é€çµ¦æ¨¡å‹å¯èƒ½æœƒå› ç‚º Token æ•¸è¶…é™è€Œå¤±æ•—ã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`)) {
            sysMsg.textContent = 'ç”Ÿæˆå·²å–æ¶ˆã€‚è«‹ç²¾ç°¡å…§å®¹å¾Œå†è©¦ã€‚';
            return;
        }
    }

    setControlsDisabled(true); 
    output.textContent = 'â³ æ­£åœ¨ç”Ÿæˆä¸­... (è«‹è€å¿ƒç­‰å¾…)'; 
    sysMsg.textContent = `ä½¿ç”¨ ${provider.toUpperCase()} (Model: ${modelName}) æ’°å¯«è…³æœ¬â€¦`;
    
    const mode = document.querySelector('input[name="mode"]:checked')?.value || 'topic';
    
    const ac = new AbortController();
    const timeout = setTimeout(() => ac.abort(), USE_TIMEOUT_MS);

    try {
      const scriptPrompt = buildScriptPrompt(mode, raw.trim()); 
      const result = await callChatCompletions({ provider, modelName, prompt: scriptPrompt, signal: ac.signal });

      output.innerHTML = marked.parse(result); 
      sysMsg.textContent = 'âœ… å·²å®Œæˆ (å¯ç›´æ¥é¸å–è¡¨æ ¼è²¼åˆ° Google Sheets)';
    
    } catch (err) {
      let errorMsg = '';
      if (err.name === 'AbortError') {
        errorMsg = 'âŒ éŒ¯èª¤ï¼šæ“ä½œè¶…æ™‚ï¼Œå·²çµ‚æ­¢è«‹æ±‚ã€‚';
        sysMsg.textContent = 'è«‹æ±‚å·²è¶…æ™‚ï¼ˆç¶²è·¯é€£ç·šã€å…§å®¹éé•·æˆ–æ¨¡å‹å»¶é²ï¼‰ã€‚';
      
      } else if (err.message.includes('HTTP 401')) {
        errorMsg = `âŒ éŒ¯èª¤ï¼š${provider.toUpperCase()} Key ç„¡æ•ˆæˆ–æˆæ¬Šå¤±æ•— (HTTP 401)ã€‚`;
        sysMsg.textContent = `è«‹æª¢æŸ¥æ‚¨çš„ ${provider.toUpperCase()} API Key æ˜¯å¦æ­£ç¢ºä¸”æœ‰æ•ˆã€‚`;
      
      } else if (err.message.includes('HTTP 429')) {
        errorMsg = `âŒ éŒ¯èª¤ï¼š${err?.message || 'HTTP 429'}`;
        sysMsg.textContent = `éŒ¯èª¤ï¼šå·²é” ${provider.toUpperCase()} API é€Ÿç‡æˆ–é¡åº¦ä¸Šé™ (Quota)ã€‚è«‹ç™»å…¥è©²å¹³å°æª¢æŸ¥æ‚¨çš„å¸³å–®èˆ‡ä»˜æ¬¾è¨­å®šã€‚`;
      
      } else if (err.message.includes('400') && err.message.includes('maximum context length')) {
        errorMsg = 'âŒ éŒ¯èª¤ï¼šè¼¸å…¥å…§å®¹éé•·ï¼Œè¶…éæ¨¡å‹æœ€å¤§ Token é™åˆ¶ã€‚';
        sysMsg.textContent = 'è«‹ç²¾ç°¡æ‚¨çš„æ–‡ç« å…§å®¹å¾Œå†è©¦ã€‚';
      
      } else {
        errorMsg = `âŒ éŒ¯èª¤ï¼š${err?.message || err.toString()}`;
        sysMsg.textContent = 'ç™¼ç”ŸéŒ¯èª¤ï¼ˆè«‹æª¢æŸ¥ Keyã€ç”¨é‡æˆ–ä¸»æ§å°ï¼‰ã€‚';
      }
      
      output.textContent = errorMsg; // éŒ¯èª¤è¨Šæ¯ä½¿ç”¨ textContent
      console.error(err);
    
    } finally {
      clearTimeout(timeout);
      setControlsDisabled(false);
      updateGenerateButtonState();
    }
  });

  // === è¤‡è£½ / ä¸‹è¼‰ (ä¸è®Š) ===
  el('btnCopy').addEventListener('click', async () => {
    const html = output.innerHTML;
    const text = output.textContent; // å‚™ç”¨çš„ç´”æ–‡å­—

    if (!text || text.startsWith('âŒ éŒ¯èª¤') || text.startsWith('è«‹è¼¸å…¥')) {
        showCopyMessage('è«‹å…ˆç”Ÿæˆæœ‰æ•ˆçš„å…§å®¹ã€‚', true);
        return;
    }
    
    try {
        const blob = new Blob([html], { type: 'text/html' });
        // @ts-ignore
        const item = new ClipboardItem({
            'text/html': blob,
            'text/plain': new Blob([text], { type: 'text/plain' })
        });
        // @ts-ignore
        await navigator.clipboard.write([item]);
        showCopyMessage('âœ… å·²è¤‡è£½è¡¨æ ¼ (å¯è²¼åˆ° Google Docs/Sheets)', false);
    
    } catch (error) {
        // å¦‚æœå¯Œæ–‡æœ¬å¤±æ•— (ä¾‹å¦‚ç€è¦½å™¨ä¸æ”¯æ´)ï¼Œå‰‡é™ç´šå›ç´”æ–‡å­—
        try {
            await navigator.clipboard.writeText(text);
            showCopyMessage('âœ… å·²è¤‡è£½ç´”æ–‡å­— (å¯Œæ–‡æœ¬è¤‡è£½å¤±æ•—)', false);
        } catch (err2) {
            showCopyMessage('âŒ è¤‡è£½å¤±æ•—ï¼Œç€è¦½å™¨æ¬Šé™ä¸è¶³ã€‚', true);
            console.error(err2);
        }
    }
  });

  el('btnDownload').addEventListener('click', () => {
    const text = output.textContent; 
    if (!text || text.startsWith('âŒ éŒ¯èª¤') || text.startsWith('è«‹è¼¸å…¥')) {
        showCopyMessage('è«‹å…ˆç”Ÿæˆæœ‰æ•ˆçš„å…§å®¹ã€‚', true);
        return;
    }
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'çŸ­å½±éŸ³è…³æœ¬.txt';
    a.click();
    showCopyMessage('âœ… å·²é–‹å§‹ä¸‹è¼‰ .txt æª”æ¡ˆ', false);
  });
  </script>
</body>
</html>

