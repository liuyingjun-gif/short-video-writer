<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>çŸ­å½±éŸ³è…³æœ¬ç”Ÿæˆå™¨ï¼ˆä½¿ç”¨è€…è¼¸å…¥é‡‘é‘°ç‰ˆï¼‰</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* åŸºæœ¬æ¨£å¼ */
    body { font-family: 'Inter', sans-serif; background: #f9fafb; color: #111827; }
    .card { background: white; border-radius: 1rem; box-shadow: 0 5px 20px rgba(0,0,0,.05); padding: 1.5rem; }
    
    /* æŒ‰éˆ•æ¨£å¼ */
    .btn { border-radius: 9999px; padding: .6rem 1rem; font-weight: 600; transition: background-color 0.15s; }
    .btn-primary { background: #0284c7; color: #fff; }
    .btn-primary:hover:not(:disabled) { background: #0369a1; }
    .btn-ghost { background: #f3f4f6; color: #111827; }
    .btn-ghost:hover:not(:disabled) { background: #e5e7eb; }
    
    /* ç¦ç”¨ç‹€æ…‹ */
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ç¨‹å¼ç¢¼èˆ‡æç¤ºæ¨£å¼ */
    .code { 
      background: #0f172a; 
      color: #e2e8f0; 
      border-radius: .75rem; 
      padding: 1rem; 
      overflow: auto; 
      white-space: pre-wrap; 
      font-size: 0.875rem;
    }
    .muted { color:#6b7280; font-size:12px }
    .warn { color:#dc2626; font-weight: 700; } 
  </style>
</head>
<body>
  <header class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-2">çŸ­å½±éŸ³è…³æœ¬ç”Ÿæˆå™¨ ğŸ¬</h1>
    <p class="text-gray-600">æ­¤ç‰ˆæœ¬è®“ä½¿ç”¨è€…è‡ªè¡Œè¼¸å…¥ OpenAI API Keyï¼Œè³‡æ–™åƒ…å„²å­˜åœ¨æœ¬æ©Ÿç€è¦½å™¨ã€‚</p>
  </header>

  <main class="max-w-4xl mx-auto px-4 space-y-6 pb-24">
    <div class="card">
      <h2 class="text-xl font-semibold mb-3">ç¬¬ä¸€æ­¥ï¼šè¼¸å…¥ä½ çš„ OpenAI API Key</h2>
      <p class="text-sm text-gray-600 mb-3">è«‹è²¼ä¸Šä½ çš„ API é‡‘é‘°ï¼ˆé–‹é ­ç‚º <code>sk-</code> æˆ– <code>sk-proj-</code>ï¼‰ã€‚æ­¤é‡‘é‘°åƒ…æœƒå„²å­˜åœ¨ä½ çš„ç€è¦½å™¨ã€‚</p>
      <div class="flex gap-2 items-center">
        <input id="userApiKey" type="password" placeholder="sk-xxxxxxxxxxxxxxxx" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400">
        <button id="btnSaveKey" class="btn btn-ghost">å„²å­˜</button>
        <button id="btnClearKey" class="btn btn-ghost">æ¸…é™¤</button>
      </div>
      <p id="keyHint" class="muted mt-2"></p>
    </div>

    <div class="card">
      <h2 class="text-xl font-semibold mb-2">ç¬¬äºŒæ­¥ï¼šè²¼ä¸Šæ–‡ç« æˆ–é€å­—ç¨¿</h2>
      <div class="flex items-center justify-between mb-2 text-sm">
        <div class="text-gray-700">å»ºè­°å­—æ•¸ï¼š<span id="charLimit" class="font-semibold"></span> å­—</div>
        <div class="text-gray-700">å·²è¼¸å…¥ï¼š<span id="charCount" class="font-semibold">0</span>ï¼å»ºè­°ç¯„åœå…§å‰©é¤˜ï¼š<span id="charRemain" class="font-semibold">0</span></div>
      </div>
      <textarea id="inputText" rows="10" placeholder="è«‹è²¼ä¸Šé€å­—ç¨¿æˆ–æ–‡ç« å…§å®¹...ï¼ˆæ³¨æ„ï¼šé•·æ–‡å¯èƒ½è¶…å‡ºæ¨¡å‹å–®æ¬¡è™•ç†é™åˆ¶ï¼‰" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400"></textarea>
      <p class="muted mt-2">æç¤ºï¼šè‹¥å…§å®¹éé•·ï¼Œè«‹è‡ªè¡Œç²¾ç°¡ï¼Œä»¥é¿å…è¶…å‡ºæ¨¡å‹çš„ Token é™åˆ¶å°è‡´ç”Ÿæˆå¤±æ•—ã€‚</p>
    </div>

    <div class="card">
      <h2 class="text-xl font-semibold mb-3">ç¬¬ä¸‰æ­¥ï¼šé¸æ“‡å½±ç‰‡å‹æ…‹èˆ‡æ¨¡å‹</h2>
      <div class="space-y-2 mb-4">
        <label class="flex items-start gap-3 cursor-pointer">
          <input type="radio" name="mode" value="podcast" checked>
          <span><strong>Podcast ä¸€é¡åˆ°åº•å‹ï¼š</strong>æä¾› 5 æ®µ 45â€“75 ç§’é‡é»ç‰‡æ®µ</span>
        </label>
        <label class="flex items-start gap-3 cursor-pointer">
          <input type="radio" name="mode" value="topic">
          <span><strong>è­°é¡Œå‹ï¼š</strong>60 ç§’æ—ç™½è…³æœ¬ + å»ºè­°ç•«é¢</span>
        </label>
        <label class="flex items-start gap-3 cursor-pointer">
          <input type="radio" name="mode" value="people">
          <span><strong>äººç‰©æ•…äº‹å‹ï¼š</strong>åŸéŸ³æ‘˜éŒ„ + æ—ç™½ + ç•«é¢</span>
        </label>
      </div>

      <div class="flex flex-wrap items-center gap-4">
        <label class="text-sm text-gray-700">æ¨¡å‹ï¼š</label>
        <select id="modelSelect" class="p-2 border border-gray-300 rounded-lg text-sm">
          <option value="gpt-4o-mini" selected>gpt-4o-miniï¼ˆå»ºè­°ã€é«˜CPå€¼ï¼‰</option>
          <option value="gpt-4o">gpt-4oï¼ˆé«˜éšæ¨ç†ï¼‰</option>
          <option value="gpt-3.5-turbo">gpt-3.5-turboï¼ˆé€Ÿåº¦å¿«ã€ä½æˆæœ¬ï¼‰</option>
        </select>
        <label class="flex items-center gap-2 text-sm ml-4 text-gray-500">
        </label>
      </div>
      <p class="muted mt-2">æœ¬å·¥å…·ä½¿ç”¨ <code>/v1/chat/completions</code> ç«¯é»ã€‚</p>
    </div>

    <div class="card">
      <h2 class="text-xl font-semibold mb-3">ç¬¬å››æ­¥ï¼šç”Ÿæˆè…³æœ¬</h2>
      <button id="btnGenerate" class="btn btn-primary" disabled>ç¢ºèªç”Ÿæˆ</button>
      <p id="sysMsg" class="text-sm text-gray-600 mt-3"></p>
    </div>

    <div class="card">
      <h2 class="text-xl font-semibold mb-3">çµæœï¼š</h2>
      <div class="flex flex-wrap gap-2 mb-3">
        <button id="btnCopy" class="btn btn-ghost">è¤‡è£½</button>
        <button id="btnDownload" class="btn btn-ghost">ä¸‹è¼‰ .txt</button>
      </div>
      <pre id="output" class="code">è«‹è¼¸å…¥ API Key ä¸¦è²¼ä¸Šæ–‡ç« ä»¥é–‹å§‹ç”Ÿæˆã€‚</pre>
    </div>
  </main>

  <script>
  // === é…ç½®åƒæ•¸ ===
  const INPUT_CHAR_LIMIT = 10000; 
  const USE_TIMEOUT_MS = 120_000; // 2åˆ†é˜è¶…æ™‚

  // === ç‹€æ…‹å„²å­˜ ===
  const KEY_STORAGE = 'user_api_key';
  const MASK = '********';

  // === DOM å…ƒç´ å¼•ç”¨ ===
  const el = id => document.getElementById(id);
  const keyInput = el('userApiKey');
  const saveBtn = el('btnSaveKey');
  const clearBtn = el('btnClearKey');
  const generateBtn = el('btnGenerate');
  const output = el('output');
  const sysMsg = el('sysMsg');
  const keyHint = el('keyHint');
  const modelSelect = el('modelSelect');
  const inputText = el('inputText');
  const charLimit = el('charLimit');
  const charCount = el('charRemain').previousElementSibling; 
  const charRemain = el('charRemain');
  const modeRadios = document.querySelectorAll('input[name="mode"]');
  const controlElements = [generateBtn, modelSelect, inputText, ...modeRadios];

  // === ç‹€æ…‹åˆå§‹åŒ– ===
  let userApiKey = localStorage.getItem(KEY_STORAGE) || '';
  if (userApiKey) {
    keyInput.value = MASK;
    keyHint.textContent = `ç›®å‰å·²å„²å­˜é‡‘é‘°ï¼šsk-****${userApiKey.slice(-4)}ï¼ˆåƒ…å­˜åœ¨ç€è¦½å™¨ï¼‰`;
    output.textContent = 'å·²åµæ¸¬åˆ°é‡‘é‘°ï¼Œè«‹è²¼ä¸Šæ–‡ç« ä¸¦é»æ“Šã€Œç¢ºèªç”Ÿæˆã€ã€‚';
  }
  charLimit.textContent = INPUT_CHAR_LIMIT.toLocaleString();
  updateCharCounter();
  updateGenerateButtonState();

  // === UI æ§åˆ¶ï¼šå­—æ•¸è¨ˆæ•¸èˆ‡æŒ‰éˆ•ç‹€æ…‹ ===
  function updateCharCounter() {
    const len = inputText.value.length;
    charCount.textContent = len.toLocaleString();
    const remain = INPUT_CHAR_LIMIT - len;

    charRemain.textContent = remain.toLocaleString();
    
    if (remain < 0) {
      charRemain.classList.add('warn');
    } else {
      charRemain.classList.remove('warn');
    }
    updateGenerateButtonState();
  }
  inputText.addEventListener('input', updateCharCounter);
  
  function updateGenerateButtonState() {
    const hasKey = Boolean(userApiKey);
    const hasInput = inputText.value.trim().length > 0;
    generateBtn.disabled = !(hasKey && hasInput);
  }

  function setControlsDisabled(disabled) {
    controlElements.forEach(el => el.disabled = disabled);
    keyInput.disabled = disabled; 
    saveBtn.disabled = disabled;
    clearBtn.disabled = disabled;
  }

  // === 
  // === API Key å„²å­˜é‚è¼¯ (æ”¯æ´ sk- å’Œ sk-proj-) ===
  // ===
  saveBtn.addEventListener('click', () => {
    const val = keyInput.value.trim();
    
    if (val === MASK && userApiKey) {
        keyHint.textContent = `âœ… é‡‘é‘°æœªè®Šæ›´ï¼šsk-****${userApiKey.slice(-4)}ï¼ˆå·²å„²å­˜ï¼‰`;
        return; 
    }
    
    // æ”¯æ´ sk- æˆ– sk-proj- é–‹é ­ï¼Œä¸¦å…è¨±å­—æ¯ã€æ•¸å­—ã€ä¸‹åŠƒç·šã€é€£å­—ç¬¦
    const API_KEY_REGEX = /^sk-(proj-)?[a-zA-Z0-9_-]{40,}$/;

    if (!API_KEY_REGEX.test(val)) {
      keyHint.innerHTML = '<span class="warn">è«‹æª¢æŸ¥ API Key æ ¼å¼æ˜¯å¦æ­£ç¢ºï¼ˆå¿…é ˆä»¥ sk- æˆ– sk-proj- é–‹é ­ï¼‰ï¼Œå„²å­˜å¤±æ•—ã€‚</span>';
      return;
    }
    
    // å„²å­˜æˆåŠŸ
    localStorage.setItem(KEY_STORAGE, val);
    userApiKey = val;
    keyInput.value = MASK;
    keyHint.textContent = `âœ… API Key å·²å„²å­˜æ–¼ç€è¦½å™¨ï¼šsk-****${userApiKey.slice(-4)}`;
    updateGenerateButtonState();
  });


  clearBtn.addEventListener('click', () => {
    localStorage.removeItem(KEY_STORAGE);
    userApiKey = '';
    keyInput.value = '';
    keyHint.textContent = 'ğŸ”’ å·²æ¸…é™¤ API Keyï¼Œè«‹é‡æ–°è¼¸å…¥';
    output.textContent = 'è«‹è¼¸å…¥ API Key ä¸¦è²¼ä¸Šæ–‡ç« ä»¥é–‹å§‹ç”Ÿæˆã€‚';
    updateGenerateButtonState();
  });

  // === OpenAI å‘¼å«ï¼ˆ/v1/chat/completionsï¼‰ ===
  async function callChatCompletions({ model, prompt, signal }) {
    const MAX_RETRY = 3;
    let attempt = 0;
    let lastErr;
    
    let systemMessageContent = 'ä½ æ˜¯ä¸€å€‹æœ‰å¹«åŠ©ã€å°ˆæ¥­çš„åŠ©ç†ã€‚';
    
    const promptLines = prompt.split('\n');
    if (promptLines[0].startsWith('ä½ æ˜¯')) {
        systemMessageContent = promptLines[0];
        prompt = promptLines.slice(1).join('\n').trim(); 
    }
    
    const messages = [
      { role: 'system', content: systemMessageContent },
      { role: 'user', content: prompt }
    ];

    while (attempt < MAX_RETRY) {
      try {
        const res = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${userApiKey}`, 
          },
          body: JSON.stringify({
            model,
            messages, 
            temperature: 0.7,
            stream: false,
          }),
          signal
        });

        const raw = await res.text();
        let data;
        try { data = JSON.parse(raw); } catch { data = null; }

        if (!res.ok) {
          const msg = data?.error?.message || raw || `HTTP ${res.status}`;
          if (res.status === 429) { 
            const backoff = Math.min(2000 * (attempt + 1), 8000);
            await new Promise(r => setTimeout(r, backoff));
            attempt++;
            lastErr = new Error(`HTTP 429ï½œ${msg}`);
            continue; 
          }
          throw new Error(`HTTP ${res.status} ${res.statusText}ï½œ${msg}`);
        }

        const textOut = data?.choices?.[0]?.message?.content || ''; 
        return textOut;
      } catch (e) {
        if (e.name === 'AbortError') throw e;
        lastErr = e;
        const backoff = Math.min(1500 * (attempt + 1), 6000);
        await new Promise(r => setTimeout(r, backoff));
        attempt++; 
      }
    }
    throw lastErr || new Error('å‘¼å«å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦');
  }

  // === ä»»å‹™ï¼šè…³æœ¬æç¤ºè© (ä½¿ç”¨å­—ä¸²æ¨¡æ¿) ===
  function buildScriptPrompt(mode, sourceText) {
    const base = `ä½ æ˜¯å°ç£ä¸­æ–‡å…§å®¹è£½ä½œçš„çŸ­å½±éŸ³è…³æœ¬ç·¨åŠ‡ï¼Œè«‹ç”¨ç¹é«”ä¸­æ–‡æ’°å¯« Markdown æ ¼å¼è¼¸å‡ºã€‚`;
    let task = '';
    if (mode === 'podcast') task = 'è«‹é¸å‡º 5 æ®µ 45â€“75 ç§’å¯ä¸€é¡åˆ°åº•çš„é‡é»ç‰‡æ®µï¼Œé™„æ™‚é–“ç¢¼èˆ‡é‡é»ï¼Œå…§å®¹åŸºæ–¼ä»¥ä¸‹åŸæ–‡ã€‚';
    else if (mode === 'topic') task = 'è«‹å¯«å‡º 60 ç§’è­°é¡Œå‹æ—ç™½è…³æœ¬ï¼Œé™„å»ºè­°æ™‚é–“èˆ‡ç•«é¢ï¼Œå…§å®¹åŸºæ–¼ä»¥ä¸‹åŸæ–‡ã€‚';
    else task = 'è«‹å¯«å‡º 60 ç§’äººç‰©æ•…äº‹å‹è…³æœ¬ï¼ŒåŒ…å«åŸéŸ³æ‘˜éŒ„ã€å¤§æ„èˆ‡å»ºè­°ç•«é¢ï¼Œå…§å®¹åŸºæ–¼ä»¥ä¸‹åŸæ–‡ã€‚';
    
    return `${base}
${task}

ã€åŸæ–‡ã€‘
${sourceText}`;
  }

  // === 
  // === ç”Ÿæˆä¸»æµç¨‹ (åŒ…å«å„ªåŒ–çš„ 429 éŒ¯èª¤æç¤º) ===
  // ===
  generateBtn.addEventListener('click', async () => {
    const raw = inputText.value.trim();
    if (!raw) {
        sysMsg.textContent = 'è«‹å…ˆè²¼ä¸Šå…§å®¹ï¼';
        return;
    }
    if (!userApiKey) {
        sysMsg.textContent = 'è«‹å…ˆè¼¸å…¥ä½ çš„ OpenAI API Keyï¼';
        return;
    }
    
    if (raw.length > INPUT_CHAR_LIMIT) {
        if (!confirm(`è­¦å‘Šï¼šæ‚¨è²¼ä¸Šçš„å…§å®¹ (${raw.length} å­—) å·²è¶…å‡ºå»ºè­°é™åˆ¶ (${INPUT_CHAR_LIMIT} å­—)ã€‚\n\nç”±æ–¼å·²ç§»é™¤è‡ªå‹•æ‘˜è¦åŠŸèƒ½ï¼Œç›´æ¥å‚³é€çµ¦æ¨¡å‹å¯èƒ½æœƒå› ç‚º Token æ•¸è¶…é™è€Œå¤±æ•—ã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`)) {
            sysMsg.textContent = 'ç”Ÿæˆå·²å–æ¶ˆã€‚è«‹ç²¾ç°¡å…§å®¹å¾Œå†è©¦ã€‚';
            return;
        }
    }

    setControlsDisabled(true); 
    output.textContent = 'â³ æ­£åœ¨ç”Ÿæˆä¸­... (è«‹è€å¿ƒç­‰å¾…)';
    sysMsg.textContent = 'AI æ­£åœ¨æ’°å¯«è…³æœ¬â€¦';
    
    const mode = document.querySelector('input[name="mode"]:checked')?.value || 'topic';
    const model = modelSelect.value;
    
    const ac = new AbortController();
    const timeout = setTimeout(() => ac.abort(), USE_TIMEOUT_MS);

    try {
      const scriptPrompt = buildScriptPrompt(mode, raw);
      const result = await callChatCompletions({ model, prompt: scriptPrompt, signal: ac.signal });

      output.textContent = result;
      sysMsg.textContent = 'âœ… å·²å®Œæˆ';
    
    } catch (err) {
      if (err.name === 'AbortError') {
        output.textContent = 'âŒ éŒ¯èª¤ï¼šæ“ä½œè¶…æ™‚ï¼Œå·²çµ‚æ­¢è«‹æ±‚ã€‚';
        sysMsg.textContent = 'è«‹æ±‚å·²è¶…æ™‚ï¼ˆç¶²è·¯é€£ç·šã€å…§å®¹éé•·æˆ–æ¨¡å‹å»¶é²ï¼‰ã€‚';
      
      } else if (err.message.includes('HTTP 401')) {
        output.textContent = `âŒ éŒ¯èª¤ï¼šAPI Key ç„¡æ•ˆæˆ–æˆæ¬Šå¤±æ•— (HTTP 401)ã€‚`;
        sysMsg.textContent = 'è«‹æª¢æŸ¥æ‚¨çš„ API Key æ˜¯å¦æ­£ç¢ºä¸”æœ‰æ•ˆã€‚';
      
      } else if (err.message.includes('HTTP 429')) {
        // **é‡å° 429 éŒ¯èª¤æä¾›æ›´ç²¾ç¢ºçš„æç¤º**
        output.textContent = `âŒ éŒ¯èª¤ï¼š${err?.message || 'HTTP 429'}`;
        sysMsg.textContent = 'éŒ¯èª¤ï¼šå·²é” API é€Ÿç‡æˆ–é¡åº¦ä¸Šé™ (Quota)ã€‚è«‹ç™»å…¥ OpenAI æª¢æŸ¥æ‚¨çš„å¸³å–®èˆ‡ä»˜æ¬¾è¨­å®šã€‚';
      
      } else if (err.message.includes('400') && err.message.includes('maximum context length')) {
        output.textContent = `âŒ éŒ¯èª¤ï¼šè¼¸å…¥å…§å®¹éé•·ï¼Œè¶…éæ¨¡å‹æœ€å¤§ Token é™åˆ¶ã€‚`;
        sysMsg.textContent = 'è«‹ç²¾ç°¡æ‚¨çš„æ–‡ç« å…§å®¹å¾Œå†è©¦ã€‚';
      
      } else {
        output.textContent = `âŒ éŒ¯èª¤ï¼š${err?.message || err.toString()}`;
        sysMsg.textContent = 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ï¼ˆè«‹æª¢æŸ¥ä¸»æ§å° Consoleï¼‰ã€‚';
      }
      console.error(err);
    
    } finally {
      clearTimeout(timeout);
      setControlsDisabled(false);
      updateGenerateButtonState();
    }
  });

  // === è¤‡è£½ / ä¸‹è¼‰ ===
  el('btnCopy').addEventListener('click', async () => {
    const text = output.textContent;
    if (!text || text.startsWith('âŒ éŒ¯èª¤')) {
        sysMsg.textContent = 'è«‹å…ˆç”Ÿæˆæœ‰æ•ˆçš„å…§å®¹ã€‚';
        return;
    }
    try {
        await navigator.clipboard.writeText(text);
        sysMsg.textContent = 'âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿';
    } catch (error) {
        sysMsg.textContent = 'âŒ è¤‡è£½å¤±æ•—ï¼Œç€è¦½å™¨æ¬Šé™ä¸è¶³ã€‚';
    }
  });

  el('btnDownload').addEventListener('click', () => {
    const text = output.textContent;
    if (!text || text.startsWith('âŒ éŒ¯èª¤')) {
        sysMsg.textContent = 'è«‹å…ˆç”Ÿæˆæœ‰æ•ˆçš„å…§å®¹ã€‚';
        return;
    }
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'çŸ­å½±éŸ³è…³æœ¬.txt';
    a.click();
  });
  </script>
</body>
</html>
