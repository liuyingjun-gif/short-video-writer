<!DOCTYPE html>
<html lang="zh-Hant">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <title>çŸ­å½±éŸ³è…³æœ¬ç”Ÿæˆå™¨ï¼ˆæ”¯æ´å¤šæ¨¡å‹ï¼‰</title>
Â  <link rel="preconnect" href="https://fonts.googleapis.com">
Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <style>
Â  Â  /* åŸºæœ¬æ¨£å¼èˆ‡è—è‰²èª¿å„ªåŒ– */
Â  Â  body { 
        font-family: 'Inter', sans-serif; 
        background: #f5f8fa; /* æ·ºè—ç°èƒŒæ™¯ */
        color: #111827; 
    }
Â  Â  .card { 
        background: white; 
        border-radius: 1.25rem; 
        box-shadow: 0 10px 30px rgba(0,0,0,.08); 
        padding: 2rem; 
        border: 1px solid #e5e7eb; 
    }
    
Â  Â  /* æŒ‰éˆ•æ¨£å¼ */
Â  Â  .btn { border-radius: 9999px; padding: .6rem 1.5rem; font-weight: 600; transition: all 0.2s; }
Â  Â  .btn-primary { 
        background: #0284c7; /* æ·±è—è‰² */
        color: #fff; 
        box-shadow: 0 4px 10px rgba(2, 132, 199, 0.4);
    }
Â  Â  .btn-primary:hover:not(:disabled) { background: #0369a1; box-shadow: 0 6px 15px rgba(2, 132, 199, 0.5); }
Â  Â  .btn-ghost { 
        background: #e1e9f1; /* æ·ºç°è‰²åº•è‰²å¡Š */
        color: #1f2937; /* æ·±ç°æ–‡å­— */
        border: 1px solid #c7d2fe; 
    } 
Â  Â  .btn-ghost:hover:not(:disabled) { background: #d3dce6; } 
Â  Â Â 
Â  Â  /* ç¦ç”¨ç‹€æ…‹ */
Â  Â  .btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }

Â  Â  /* è¼¸å…¥æ¡†æ¨£å¼å„ªåŒ– */
Â  Â  .input-style {
        padding: 0.75rem;
        border: 1px solid #cbd5e1;
        border-radius: 0.75rem;
        transition: border-color 0.2s;
        background-color: #f7f9fb; /* æ·ºç°è—èƒŒæ™¯ */
    }
    .input-style:focus {
        border-color: #0284c7;
        outline: none;
        box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.2);
        background-color: white; /* èšç„¦æ™‚è®Šç‚ºç™½è‰² */
    }
    .input-style:disabled {
        background-color: #e5e7eb;
    }

Â  Â  /* ç¨‹å¼ç¢¼èˆ‡æç¤ºæ¨£å¼ */
Â  Â  .code {Â 
Â  Â  Â  background: #1f2937; /* æ·±ç°è‰² */
Â  Â  Â  color: #f9fafb;Â 
Â  Â  Â  border-radius: .75rem;Â 
Â  Â  Â  padding: 1.5rem;Â  
Â  Â  Â  overflow: auto;Â 
Â  Â  Â  white-space: pre-wrap;Â 
Â  Â  Â  font-size: 0.875rem;
Â  Â  }
Â  Â  .muted { color:#6b7280; font-size:12px }
Â  Â  .warn { color:#dc2626; font-weight: 700; }Â 
Â  </style>
</head>
<body>
Â  <header class="max-w-4xl mx-auto px-4 py-10">
Â  Â  <h1 class="text-4xl font-extrabold mb-2 text-sky-700">çŸ­å½±éŸ³è…³æœ¬ç”Ÿæˆå™¨ ğŸ¬</h1>
Â  Â  <p class="text-gray-600">æ­¤ç‰ˆæœ¬æ”¯æ´ OpenAI åŠ Gemini APIï¼Œé‡‘é‘°åƒ…å„²å­˜åœ¨æœ¬æ©Ÿç€è¦½å™¨ã€‚</p>
Â  </header>

Â  <main class="max-w-4xl mx-auto px-4 space-y-8 pb-24">
Â  Â  <div class="card">
Â  Â  Â  <h2 class="text-2xl font-semibold mb-4 text-gray-800">ç¬¬ä¸€æ­¥ï¼šè¼¸å…¥ä½ çš„ API Key</h2>
Â  Â  Â Â 
Â  Â  Â  <div class="mb-5">
Â  Â  Â  Â  <label for="openaiApiKey" class="block text-sm font-medium text-gray-700 mb-2">OpenAI API Key (sk-)</label>
Â  Â  Â  Â  <div class="flex gap-3 items-center">
Â  Â  Â  Â  Â  <input id="openaiApiKey" type="password" placeholder="sk-xxxxxxxxxxxxxxxx" class="flex-1 input-style">
Â  Â  Â  Â  Â  <button id="btnSaveOpenAIKey" class="btn btn-ghost">å„²å­˜</button>
Â  Â  Â  Â  Â  <button id="btnClearOpenAIKey" class="btn btn-ghost">æ¸…é™¤</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <p id="openaiKeyHint" class="muted mt-2"></p>
Â  Â  Â  </div>

Â  Â  Â  <div>
Â  Â  Â  Â  <label for="geminiApiKey" class="block text-sm font-medium text-gray-700 mb-2">Gemini API Key (AIza)</label>
Â  Â  Â  Â  <div class="flex gap-3 items-center">
Â  Â  Â  Â  Â  <input id="geminiApiKey" type="password" placeholder="AIzaSyAxxxxxxxxxxxxxxxxx" class="flex-1 input-style">
Â  Â  Â  Â  Â  <button id="btnSaveGeminiKey" class="btn btn-ghost">å„²å­˜</button>
Â  Â  Â  Â  Â  <button id="btnClearGeminiKey" class="btn btn-ghost">æ¸…é™¤</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <p id="geminiKeyHint" class="muted mt-2"></p>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="card">
Â  Â  Â  <h2 class="text-2xl font-semibold mb-4 text-gray-800">ç¬¬äºŒæ­¥ï¼šè²¼ä¸Šæ–‡ç« æˆ–é€å­—ç¨¿</h2>
Â  Â  Â  <div class="flex items-center justify-between mb-3 text-sm">
Â  Â  Â  Â  <div class="text-gray-700">å»ºè­°å­—æ•¸ï¼š<span id="charLimit" class="font-semibold text-sky-600"></span> å­—</div>
Â  Â  Â  Â  <div class="text-gray-700">å·²è¼¸å…¥ï¼š<span id="charCount" class="font-semibold text-sky-600">0</span>ï¼å»ºè­°ç¯„åœå…§å‰©é¤˜ï¼š<span id="charRemain" class="font-semibold text-sky-600">0</span></div>
Â  Â  Â  </div>
Â  Â  Â  <textarea id="inputText" rows="10" placeholder="è«‹è²¼ä¸Šé€å­—ç¨¿æˆ–æ–‡ç« å…§å®¹...ï¼ˆæ³¨æ„ï¼šé•·æ–‡å¯èƒ½è¶…å‡ºæ¨¡å‹å–®æ¬¡è™•ç†é™åˆ¶ï¼‰" class="w-full input-style"></textarea>
Â  Â  Â  <p class="muted mt-2">æç¤ºï¼šè‹¥å…§å®¹éé•·ï¼Œè«‹è‡ªè¡Œç²¾ç°¡ï¼Œä»¥é¿å…è¶…å‡ºæ¨¡å‹çš„ Token é™åˆ¶å°è‡´ç”Ÿæˆå¤±æ•—ã€‚</p>
Â  Â  </div>

Â  Â  <div class="card">
Â  Â  Â  <h2 class="text-2xl font-semibold mb-4 text-gray-800">ç¬¬ä¸‰æ­¥ï¼šé¸æ“‡å½±ç‰‡å‹æ…‹èˆ‡æ¨¡å‹</h2>
Â  Â  Â  <div class="space-y-3 mb-5">
Â  Â  Â  Â  <label class="flex items-start gap-3 cursor-pointer">
Â  Â  Â  Â  Â  <input type="radio" name="mode" value="podcast" checked class="mt-1 accent-sky-600">
Â  Â  Â  Â  Â  <span><strong>Podcast ä¸€é¡åˆ°åº•å‹ï¼š</strong>æä¾› 5 æ®µ 45â€“75 ç§’é‡é»ç‰‡æ®µ</span>
Â  Â  Â  Â  </label>
Â  Â  Â  Â  <label class="flex items-start gap-3 cursor-pointer">
Â  Â  Â  Â  Â  <input type="radio" name="mode" value="topic" class="mt-1 accent-sky-600">
Â  Â  Â  Â  Â  <span><strong>è­°é¡Œå‹ï¼š</strong>60 ç§’æ—ç™½è…³æœ¬ + å»ºè­°ç•«é¢</span>
Â  Â  Â  Â  </label>
Â  Â  Â  Â  <label class="flex items-start gap-3 cursor-pointer">
Â  Â  Â  Â  Â  <input type="radio" name="mode" value="people" class="mt-1 accent-sky-600">
Â  Â  Â  Â  Â  <span><strong>äººç‰©æ•…äº‹å‹ï¼šï¼š</strong>åŸéŸ³æ‘˜éŒ„ + æ—ç™½ + ç•«é¢</span>
Â  Â  Â  Â  </label>
Â  Â  Â  </div>

Â  Â  Â  <div class="flex flex-wrap items-center gap-4">
Â  Â  Â  Â  <label class="text-sm text-gray-700 font-medium">é¸æ“‡æ¨¡å‹ï¼š</label>
Â  Â  Â  Â  <select id="modelSelect" class="input-style text-sm">
Â  Â  Â  Â  Â  <optgroup label="OpenAI (éœ€è¦ sk- Key)">
Â  Â  Â  Â  Â  Â  <option value="openai:gpt-4o-mini" selected>GPT-4o miniï¼ˆå»ºè­°ï¼‰</option>
Â  Â  Â  Â  Â  Â  <option value="openai:gpt-4o">GPT-4oï¼ˆé«˜éšæ¨ç†ï¼‰</option>
Â  Â  Â  Â  Â  Â  <option value="openai:gpt-3.5-turbo">GPT-3.5 Turboï¼ˆä½æˆæœ¬ï¼‰</option>
Â  Â  Â  Â  Â  </optgroup>
Â  Â  Â  Â  Â  <optgroup label="Google (éœ€è¦ AIza Key)">
Â  Â  Â  Â  Â  Â  <option value="gemini:gemini-2.5-flash">Gemini 2.5 Flashï¼ˆé«˜CPå€¼ã€å¿«é€Ÿï¼‰</option>
Â  Â  Â  Â  Â  Â  <option value="gemini:gemini-2.5-pro">Gemini 2.5 Proï¼ˆé€²éšæ¨ç†ï¼‰</option>
Â  Â  Â  Â  Â  </optgroup>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>
Â  Â  Â  <p class="muted mt-3">OpenAI ä½¿ç”¨ <code>/v1/chat/completions</code>ï¼›Gemini ä½¿ç”¨ <code>/v1beta/models/...:generateContent</code> ç«¯é»ã€‚</p>
Â  Â  </div>

Â  Â  <div class="card">
Â  Â  Â  <h2 class="text-2xl font-semibold mb-4 text-gray-800">ç¬¬å››æ­¥ï¼šç”Ÿæˆè…³æœ¬</h2>
Â  Â  Â  <button id="btnGenerate" class="btn btn-primary" disabled>ç¢ºèªç”Ÿæˆ</button>
Â  Â  Â  <p id="sysMsg" class="text-sm text-gray-600 mt-4"></p>
Â  Â  </div>

Â  Â  <div class="card">
Â  Â  Â  <h2 class="text-2xl font-semibold mb-4 text-gray-800">çµæœï¼š</h2>
Â  Â  Â  <div class="flex flex-wrap gap-3 mb-4">
Â  Â  Â  Â  <button id="btnCopy" class="btn btn-ghost">è¤‡è£½çµæœ</button>
Â  Â  Â  Â  <button id="btnDownload" class="btn btn-ghost">ä¸‹è¼‰ .txt</button>
Â  Â  Â  </div>
Â  Â  Â  <pre id="output" class="code">è«‹è¼¸å…¥è‡³å°‘ä¸€å€‹ API Key ä¸¦è²¼ä¸Šæ–‡ç« ä»¥é–‹å§‹ç”Ÿæˆã€‚</pre>
Â  Â  </div>
Â  </main>

Â  <script>
Â  // === é…ç½®åƒæ•¸ ===
Â  const INPUT_CHAR_LIMIT = 10000;Â 
Â  const USE_TIMEOUT_MS = 120_000; // 2åˆ†é˜è¶…æ™‚

Â  // === ç‹€æ…‹å„²å­˜éµå€¼ ===
Â  const KEY_OPENAI = 'user_openai_key';
Â  const KEY_GEMINI = 'user_gemini_key';
Â  const MASK = '********';

Â  // === DOM å…ƒç´ å¼•ç”¨ ===
Â  const el = id => document.getElementById(id);
Â Â 
Â  const openaiKeyInput = el('openaiApiKey');
Â  const btnSaveOpenAIKey = el('btnSaveOpenAIKey');
Â  const btnClearOpenAIKey = el('btnClearOpenAIKey');
Â  const openaiKeyHint = el('openaiKeyHint');

Â  const geminiKeyInput = el('geminiApiKey');
Â  const btnSaveGeminiKey = el('btnSaveGeminiKey');
Â  const btnClearGeminiKey = el('btnClearGeminiKey');
Â  const geminiKeyHint = el('geminiKeyHint');
Â Â 
Â  const generateBtn = el('btnGenerate');
Â  const output = el('output');
Â  const sysMsg = el('sysMsg');
Â  const modelSelect = el('modelSelect');
Â  const inputText = el('inputText');
Â  const charLimit = el('charLimit');
Â  const charCount = el('charRemain').previousElementSibling;Â 
Â  const charRemain = el('charRemain');
Â  const modeRadios = document.querySelectorAll('input[name="mode"]');
Â  const controlElements = [generateBtn, modelSelect, inputText, ...modeRadios];

Â  // === ç‹€æ…‹åˆå§‹åŒ– ===
Â  let userOpenAIKey = localStorage.getItem(KEY_OPENAI) || '';
Â  let userGeminiKey = localStorage.getItem(KEY_GEMINI) || '';

Â  function loadKeys() {
Â  Â  if (userOpenAIKey) {
Â  Â  Â  openaiKeyInput.value = MASK;
Â  Â  Â  openaiKeyHint.textContent = `âœ… å·²å„²å­˜ OpenAI Keyï¼šsk-****${userOpenAIKey.slice(-4)}`;
Â  Â  } else {
Â  Â  Â  openaiKeyInput.value = '';
Â  Â  Â  openaiKeyHint.textContent = 'è«‹è¼¸å…¥ OpenAI Key';
Â  Â  }

Â  Â  if (userGeminiKey) {
Â  Â  Â  geminiKeyInput.value = MASK;
Â  Â  Â  geminiKeyHint.textContent = `âœ… å·²å„²å­˜ Gemini Keyï¼šAIza****${userGeminiKey.slice(-4)}`;
Â  Â  } else {
Â  Â  Â  geminiKeyInput.value = '';
Â  Â  Â  geminiKeyHint.textContent = 'è«‹è¼¸å…¥ Gemini Key';
Â  Â  }
Â  }

Â  loadKeys();
Â  charLimit.textContent = INPUT_CHAR_LIMIT.toLocaleString();
Â  updateCharCounter();
Â  updateGenerateButtonState();

Â  // === UI æ§åˆ¶ï¼šå­—æ•¸è¨ˆæ•¸èˆ‡æŒ‰éˆ•ç‹€æ…‹ ===
Â  function updateCharCounter() {
Â  Â  const len = inputText.value.length;
Â  Â  charCount.textContent = len.toLocaleString();
Â  Â  const remain = INPUT_CHAR_LIMIT - len;

Â  Â  charRemain.textContent = remain.toLocaleString();
Â  Â Â 
Â  Â  if (remain < 0) {
Â  Â  Â  charRemain.classList.add('warn');
Â  Â  } else {
Â  Â  Â  charRemain.classList.remove('warn');
Â  Â  }
Â  Â  updateGenerateButtonState();
Â  }
Â  inputText.addEventListener('input', updateCharCounter);
Â  modelSelect.addEventListener('change', updateGenerateButtonState);Â 
Â Â 
Â  function updateGenerateButtonState() {
Â  Â  const [provider, modelName] = modelSelect.value.split(':');
Â  Â  const hasInput = inputText.value.trim().length > 0;
Â  Â Â 
Â  Â  let hasKey = false;
Â  Â  
Â  Â  // æ ¸å¿ƒé‚è¼¯ï¼šåƒ…æª¢æŸ¥æ‰€é¸æ¨¡å‹å°æ‡‰çš„ Key æ˜¯å¦å­˜åœ¨
Â  Â  if (provider === 'openai') {
Â  Â  Â  hasKey = Boolean(userOpenAIKey); 
Â  Â  }Â 
Â  Â  else if (provider === 'gemini') {
Â  Â  Â  hasKey = Boolean(userGeminiKey); 
Â  Â  }

Â  Â  generateBtn.disabled = !(hasKey && hasInput);

Â  Â  if (!hasKey) {
Â  Â  Â  sysMsg.textContent = `è«‹å…ˆå„²å­˜æœ‰æ•ˆçš„ ${provider.toUpperCase()} API Keyï¼Œæ‰èƒ½ä½¿ç”¨ ${modelName} æ¨¡å‹ã€‚`;
Â  Â  } else {
Â  Â  Â  sysMsg.textContent = 'å·²å°±ç·’ï¼Œé»æ“Šç¢ºèªç”Ÿæˆã€‚';
Â  Â  }
Â  }

Â  function setControlsDisabled(disabled) {
Â  Â  controlElements.forEach(el => el.disabled = disabled);
Â  Â  openaiKeyInput.disabled = disabled;Â 
Â  Â  btnSaveOpenAIKey.disabled = disabled;
Â  Â  btnClearOpenAIKey.disabled = disabled;
Â  Â  geminiKeyInput.disabled = disabled;Â 
Â  Â  btnSaveGeminiKey.disabled = disabled;
Â  Â  btnClearGeminiKey.disabled = disabled;
Â  }

Â  // === Key è™•ç†é‚è¼¯ (OpenAI) ===
Â  btnSaveOpenAIKey.addEventListener('click', () => {
Â  Â  // é—œéµä¿®æ­£ï¼šå¼·åˆ¶å»é™¤æ‰€æœ‰ç©ºæ ¼å’Œä¸å¯è¦‹å­—å…ƒ
Â  Â  const rawVal = openaiKeyInput.value;
Â  Â  const val = rawVal.replace(/\s/g, '').trim();Â 

Â  Â  if (val === MASK && userOpenAIKey) {
Â  Â  Â  Â  openaiKeyHint.textContent = `âœ… é‡‘é‘°æœªè®Šæ›´ï¼šsk-****${userOpenAIKey.slice(-4)}ï¼ˆå·²å„²å­˜ï¼‰`;
Â  Â  Â  Â  return;Â 
Â  Â  }
Â  Â  // æ”¯æ´ sk- æˆ– sk-proj- é–‹é ­
Â  Â  const API_KEY_REGEX = /^sk-(proj-)?[a-zA-Z0-9_-]{40,}$/;

Â  Â  if (!API_KEY_REGEX.test(val)) {
Â  Â  Â  openaiKeyHint.innerHTML = '<span class="warn">æ ¼å¼éŒ¯èª¤ï¼ˆå¿…é ˆä»¥ sk- æˆ– sk-proj- é–‹é ­ï¼Œä¸”é•·åº¦è¶³å¤ ï¼‰ã€‚</span>';
Â  Â  Â  return;
Â  Â  }
Â  Â  localStorage.setItem(KEY_OPENAI, val);
Â  Â  userOpenAIKey = val;
Â  Â  loadKeys();Â 
Â  Â  updateGenerateButtonState();
Â  });

Â  btnClearOpenAIKey.addEventListener('click', () => {
Â  Â  localStorage.removeItem(KEY_OPENAI);
Â  Â  userOpenAIKey = '';
Â  Â  loadKeys();
Â  Â  updateGenerateButtonState();
Â  });
Â Â 
Â  // === Key è™•ç†é‚è¼¯ (Gemini) ===
Â  btnSaveGeminiKey.addEventListener('click', () => {
Â  Â  // é—œéµä¿®æ­£ï¼šå¼·åˆ¶å»é™¤æ‰€æœ‰ç©ºæ ¼å’Œä¸å¯è¦‹å­—å…ƒ
Â  Â  const rawVal = geminiKeyInput.value;
Â  Â  const val = rawVal.replace(/\s/g, '').trim();Â 

Â  Â  if (val === MASK && userGeminiKey) {
Â  Â  Â  Â  geminiKeyHint.textContent = `âœ… é‡‘é‘°æœªè®Šæ›´ï¼šAIza****${userGeminiKey.slice(-4)}ï¼ˆå·²å„²å­˜ï¼‰`;
Â  Â  Â  Â  return;Â 
Â  Â  }
Â  Â  // ã€å·²ä¿®æ­£ã€‘å°‡ Regex çš„é•·åº¦ç¯„åœé€²ä¸€æ­¥æ”¾å¯¬ï¼Œä»¥ç¢ºä¿èƒ½å„²å­˜ Key (é•·åº¦ 39 åˆ° 55)
Â  Â  const API_KEY_REGEX = /^AIzaSy[a-zA-Z0-9_-]{33,49}$/;Â 

Â  Â  if (!API_KEY_REGEX.test(val)) {
Â  Â  Â  geminiKeyHint.innerHTML = '<span class="warn">æ ¼å¼éŒ¯èª¤ï¼ˆå¿…é ˆä»¥ AIzaSy é–‹é ­ï¼Œä¸”é•·åº¦è¶³å¤ ï¼Œç´„ 39-55 å€‹å­—å…ƒï¼‰ã€‚</span>';
Â  Â  Â  return;
Â  Â  }
Â  Â  localStorage.setItem(KEY_GEMINI, val);
Â  Â  userGeminiKey = val;
Â  Â  loadKeys();Â 
Â  Â  updateGenerateButtonState();
Â  });

Â  btnClearGeminiKey.addEventListener('click', () => {
Â  Â  localStorage.removeItem(KEY_GEMINI);
Â  Â  userGeminiKey = '';
Â  Â  loadKeys();
Â  Â  updateGenerateButtonState();
Â  });


Â  // === æ ¸å¿ƒ API å‘¼å«å‡½å¼ (æ”¯æ´ OpenAI/Gemini) ===
Â  async function callChatCompletions({ provider, modelName, prompt, signal }) {
Â  Â  const MAX_RETRY = 3;
Â  Â  let attempt = 0;
Â  Â  let lastErr;
Â  Â  let apiKey = provider === 'openai' ? userOpenAIKey : userGeminiKey;
Â  Â  let systemMessageContent = 'ä½ æ˜¯ä¸€å€‹æœ‰å¹«åŠ©ã€å°ˆæ¥­çš„åŠ©ç†ã€‚';
Â  Â Â 
Â  Â  // å¾æç¤ºè©ä¸­è§£æ System Message
Â  Â  const promptLines = prompt.split('\n');
Â  Â  if (promptLines[0].startsWith('ä½ æ˜¯')) {
Â  Â  Â  Â  systemMessageContent = promptLines[0];
Â  Â  Â  Â  prompt = promptLines.slice(1).join('\n').trim();Â 
Â  Â  }
Â  Â Â 
Â  Â  while (attempt < MAX_RETRY) {
Â  Â  Â  try {
Â  Â  Â  Â  let url, headers, body;

Â  Â  Â  Â  if (provider === 'openai') {
Â  Â  Â  Â  Â  url = 'https://api.openai.com/v1/chat/completions';
Â  Â  Â  Â  Â  headers = {
Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  'Authorization': `Bearer ${apiKey}`,
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  body = JSON.stringify({
Â  Â  Â  Â  Â  Â  model: modelName,
Â  Â  Â  Â  Â  Â  messages: [
Â  Â  Â  Â  Â  Â  Â  { role: 'system', content: systemMessageContent },
Â  Â  Â  Â  Â  Â  Â  { role: 'user', content: prompt }
Â  Â  Â  Â  Â  Â  ],Â 
Â  Â  Â  Â  Â  Â  temperature: 0.7,
Â  Â  Â  Â  Â  Â  stream: false,
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  } else if (provider === 'gemini') {
Â  Â  Â  Â  Â  // Gemini API å‘¼å«çµæ§‹ (å·²ä¿®æ­£ config -> generationConfig)
Â  Â  Â  Â  Â  url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
Â  Â  Â  Â  Â  headers = {
Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  // æ³¨æ„ï¼šæ­¤è™•å°‡ systemMessageContent ä½µå…¥ user è¨Šæ¯ä¸­
Â  Â  Â  Â  Â  body = JSON.stringify({
Â  Â  Â  Â  Â  Â  contents: [
Â  Â  Â  Â  Â  Â  Â  { role: 'user', parts: [{ text: `${systemMessageContent}\n\n${prompt}` }] }
Â  Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  Â  Â  generationConfig: {
Â  Â  Â  Â  Â  Â  Â  Â  temperature: 0.7,
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const res = await fetch(url, { method: 'POST', headers, body, signal });

Â  Â  Â  Â  const raw = await res.text();
Â  Â  Â  Â  let data;
Â  Â  Â  Â  try { data = JSON.parse(raw); } catch { data = null; }

Â  Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  Â  const msg = data?.error?.message || raw || `HTTP ${res.status}`;
Â  Â  Â  Â  Â  if (res.status === 429) {Â 
Â  Â  Â  Â  Â  Â  const backoff = Math.min(2000 * (attempt + 1), 8000);
Â  Â  Â  Â  Â  Â  await new Promise(r => setTimeout(r, backoff));
Â  Â  Â  Â  Â  Â  attempt++;
Â  Â  Â  Â  Â  Â  lastErr = new Error(`HTTP 429ï½œ${msg}`);
Â  Â  Â  Â  Â  Â  continue;Â 
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  throw new Error(`HTTP ${res.status} ${res.statusText}ï½œ${msg}`);
Â  Â  Â  Â  }

Â  Â  Â  Â  let textOut = '';
Â  Â  Â  Â  if (provider === 'openai') {
Â  Â  Â  Â  Â  Â  textOut = data?.choices?.[0]?.message?.content || '';Â 
Â  Â  Â  Â  } else if (provider === 'gemini') {
Â  Â  Â  Â  Â  Â  textOut = data?.candidates?.[0]?.content?.parts?.[0]?.text || 'Gemini è¼¸å‡ºå…§å®¹ç‚ºç©ºï¼Œå¯èƒ½è¢«å®‰å…¨éæ¿¾ã€‚';
Â  Â  Â  Â  Â  Â  // æª¢æŸ¥æ˜¯å¦è¢«å®‰å…¨éæ¿¾
Â  Â  Â  Â  Â  Â  if (!textOut && data?.candidates?.[0]?.finishReason === 'SAFETY') {
Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error(`Gemini è¼¸å‡ºè¢«å…§å®¹å®‰å…¨éæ¿¾ (SAFETY)`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (!textOut && data?.error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error(`Gemini API éŒ¯èª¤: ${data.error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  return textOut;

Â  Â  Â  } catch (e) {
Â  Â  Â  Â  if (e.name === 'AbortError') throw e;
Â  Â  Â  Â  lastErr = e;
Â  Â  Â  Â  const backoff = Math.min(1500 * (attempt + 1), 6000);
Â  Â  Â  Â  await new Promise(r => setTimeout(r, backoff));
Â  Â  Â  Â  attempt++;Â 
Â  Â  Â  }
Â  Â  }
Â  Â  throw lastErr || new Error('å‘¼å«å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦');
Â  }

Â  // === ä»»å‹™ï¼šè…³æœ¬æç¤ºè© (ä½¿ç”¨å­—ä¸²æ¨¡æ¿) ===
Â  function buildScriptPrompt(mode, sourceText) {
Â  Â  const base = `ä½ æ˜¯å°ç£ä¸­æ–‡å…§å®¹è£½ä½œçš„çŸ­å½±éŸ³è…³æœ¬ç·¨åŠ‡ï¼Œè«‹ç”¨ç¹é«”ä¸­æ–‡æ’°å¯« Markdown æ ¼å¼è¼¸å‡ºã€‚`;
Â  Â  let task = '';
Â  Â  if (mode === 'podcast') task = 'è«‹é¸å‡º 5 æ®µ 45â€“75 ç§’å¯ä¸€é¡åˆ°åº•çš„é‡é»ç‰‡æ®µï¼Œé™„æ™‚é–“ç¢¼èˆ‡é‡é»ï¼Œå…§å®¹åŸºæ–¼ä»¥ä¸‹åŸæ–‡ã€‚';
Â  Â  else if (mode === 'topic') task = 'è«‹å¯«å‡º 60 ç§’è­°é¡Œå‹æ—ç™½è…³æœ¬ + å»ºè­°ç•«é¢ï¼Œå…§å®¹åŸºæ–¼ä»¥ä¸‹åŸæ–‡ã€‚';
Â  Â  else task = 'è«‹å¯«å‡º 60 ç§’äººç‰©æ•…äº‹å‹è…³æœ¬ï¼ŒåŒ…å«åŸéŸ³æ‘˜éŒ„ã€å¤§æ„èˆ‡å»ºè­°ç•«é¢ï¼Œå…§å®¹åŸºæ–¼ä»¥ä¸‹åŸæ–‡ã€‚';
Â  Â Â 
Â  Â  return `${base}
${task}

ã€åŸæ–‡ã€‘
${sourceText}`;
Â  }

Â  // === ç”Ÿæˆä¸»æµç¨‹ ===
Â  generateBtn.addEventListener('click', async () => {
Â  Â  const raw = inputText.value.trim();
Â  Â  if (!raw) {
Â  Â  Â  Â  sysMsg.textContent = 'è«‹å…ˆè²¼ä¸Šå…§å®¹ï¼';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  const [provider, modelName] = modelSelect.value.split(':');
Â  Â  let apiKeyUsed = provider === 'openai' ? userOpenAIKey : userGeminiKey;
Â  Â Â 
Â  Â  if (!apiKeyUsed) {
Â  Â  Â  Â  sysMsg.textContent = `è«‹å…ˆè¼¸å…¥ä½ çš„ ${provider.toUpperCase()} API Keyï¼`;
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  if (raw.length > INPUT_CHAR_LIMIT) {
Â  Â  Â  Â  if (!confirm(`è­¦å‘Šï¼šæ‚¨è²¼ä¸Šçš„å…§å®¹ (${raw.length} å­—) å·²è¶…å‡ºå»ºè­°é™åˆ¶ (${INPUT_CHAR_LIMIT} å­—)ã€‚\n\nç›´æ¥å‚³é€çµ¦æ¨¡å‹å¯èƒ½æœƒå› ç‚º Token æ•¸è¶…é™è€Œå¤±æ•—ã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`)) {
Â  Â  Â  Â  Â  Â  sysMsg.textContent = 'ç”Ÿæˆå·²å–æ¶ˆã€‚è«‹ç²¾ç°¡å…§å®¹å¾Œå†è©¦ã€‚';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  setControlsDisabled(true);Â 
Â  Â  output.textContent = 'â³ æ­£åœ¨ç”Ÿæˆä¸­... (è«‹è€å¿ƒç­‰å¾…)';
Â  Â  sysMsg.textContent = `ä½¿ç”¨ ${provider.toUpperCase()} (Model: ${modelName}) æ’°å¯«è…³æœ¬â€¦`;
Â  Â Â 
Â  Â  const mode = document.querySelector('input[name="mode"]:checked')?.value || 'topic';
Â  Â Â 
Â  Â  const ac = new AbortController();
Â  Â  const timeout = setTimeout(() => ac.abort(), USE_TIMEOUT_MS);

Â  Â  try {
Â  Â  Â  const scriptPrompt = buildScriptPrompt(mode, raw);
Â  Â  Â  const result = await callChatCompletions({ provider, modelName, prompt: scriptPrompt, signal: ac.signal });

Â  Â  Â  output.textContent = result;
Â  Â  Â  sysMsg.textContent = 'âœ… å·²å®Œæˆ';
Â  Â Â 
Â  Â  } catch (err) {
Â  Â  Â  if (err.name === 'AbortError') {
Â  Â  Â  Â  output.textContent = 'âŒ éŒ¯èª¤ï¼šæ“ä½œè¶…æ™‚ï¼Œå·²çµ‚æ­¢è«‹æ±‚ã€‚';
Â  Â  Â  Â  sysMsg.textContent = 'è«‹æ±‚å·²è¶…æ™‚ï¼ˆç¶²è·¯é€£ç·šã€å…§å®¹éé•·æˆ–æ¨¡å‹å»¶é²ï¼‰ã€‚';
Â  Â  Â Â 
Â  Â  Â  } else if (err.message.includes('HTTP 401')) {
Â  Â  Â  Â  output.textContent = `âŒ éŒ¯èª¤ï¼š${provider.toUpperCase()} Key ç„¡æ•ˆæˆ–æˆæ¬Šå¤±æ•— (HTTP 401)ã€‚`;
Â  Â  Â  Â  sysMsg.textContent = `è«‹æª¢æŸ¥æ‚¨çš„ ${provider.toUpperCase()} API Key æ˜¯å¦æ­£ç¢ºä¸”æœ‰æ•ˆã€‚`;
Â  Â  Â Â 
Â  Â  Â  } else if (err.message.includes('HTTP 429')) {
Â  Â  Â  Â  output.textContent = `âŒ éŒ¯èª¤ï¼š${err?.message || 'HTTP 429'}`;
Â  Â  Â  Â  sysMsg.textContent = `éŒ¯èª¤ï¼šå·²é” ${provider.toUpperCase()} API é€Ÿç‡æˆ–é¡åº¦ä¸Šé™ (Quota)ã€‚è«‹ç™»å…¥è©²å¹³å°æª¢æŸ¥æ‚¨çš„å¸³å–®èˆ‡ä»˜æ¬¾è¨­å®šã€‚`;
Â  Â  Â Â 
Â  Â  Â  } else if (err.message.includes('400') && err.message.includes('maximum context length')) {
Â  Â  Â  Â  output.textContent = `âŒ éŒ¯èª¤ï¼šè¼¸å…¥å…§å®¹éé•·ï¼Œè¶…éæ¨¡å‹æœ€å¤§ Token é™åˆ¶ã€‚`;
Â  Â  Â  Â  sysMsg.textContent = 'è«‹ç²¾ç°¡æ‚¨çš„æ–‡ç« å…§å®¹å¾Œå†è©¦ã€‚';
Â  Â  Â Â 
Â  Â  Â  } else {
Â  Â  Â  Â  output.textContent = `âŒ éŒ¯èª¤ï¼š${err?.message || err.toString()}`;
Â  Â  Â  Â  sysMsg.textContent = `ç™¼ç”ŸéŒ¯èª¤ï¼ˆè«‹æª¢æŸ¥ Keyã€ç”¨é‡æˆ–ä¸»æ§å°ï¼‰ã€‚`;
Â  Â  Â  }
Â  Â  Â  console.error(err);
Â  Â Â 
Â  Â  } finally {
Â  Â  Â  clearTimeout(timeout);
Â  Â  Â  setControlsDisabled(false);
Â  Â  Â  updateGenerateButtonState();
Â  Â  }
Â  });

Â  // === è¤‡è£½ / ä¸‹è¼‰ ===
Â  el('btnCopy').addEventListener('click', async () => {
Â  Â  const text = output.textContent;
Â  Â  if (!text || text.startsWith('âŒ éŒ¯èª¤')) {
Â  Â  Â  Â  sysMsg.textContent = 'è«‹å…ˆç”Ÿæˆæœ‰æ•ˆçš„å…§å®¹ã€‚';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  try {
Â  Â  Â  Â  await navigator.clipboard.writeText(text);
Â  Â  Â  Â  sysMsg.textContent = 'âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿';
Â  Â  } catch (error) {
Â  Â  Â  Â  sysMsg.textContent = 'âŒ è¤‡è£½å¤±æ•—ï¼Œç€è¦½å™¨æ¬Šé™ä¸è¶³ã€‚';
Â  Â  }
Â  });

Â  el('btnDownload').addEventListener('click', () => {
Â  Â  const text = output.textContent;
Â  Â  if (!text || text.startsWith('âŒ éŒ¯èª¤')) {
Â  Â  Â  Â  sysMsg.textContent = 'è«‹å…ˆç”Ÿæˆæœ‰æ•ˆçš„å…§å®¹ã€‚';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
Â  Â  const a = document.createElement('a');
Â  Â  a.href = URL.createObjectURL(blob);
Â  Â  a.download = 'çŸ­å½±éŸ³è…³æœ¬.txt';
Â  Â  a.click();
Â  });
Â  </script>
</body>
</html>
