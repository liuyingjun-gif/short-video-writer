<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>çŸ­å½±éŸ³è…³æœ¬ç”Ÿæˆå™¨ï¼ˆä½¿ç”¨è€…è¼¸å…¥é‡‘é‘°ç‰ˆï¼‰</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: #f9fafb; color: #111827; }
    .card { background: white; border-radius: 1rem; box-shadow: 0 5px 20px rgba(0,0,0,.05); padding: 1.5rem; }
    .btn { border-radius: 9999px; padding: .6rem 1rem; font-weight: 600; }
    .btn-primary { background: #0284c7; color: #fff; }
    .btn-ghost { background: #f3f4f6; color: #111827; }
    .code { background: #0f172a; color: #e2e8f0; border-radius: .75rem; padding: 1rem; overflow: auto; white-space: pre-wrap; }
    .muted { color:#6b7280; font-size:12px }
    .warn { color:#b45309 }
  </style>
</head>
<body>
  <header class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-2">çŸ­å½±éŸ³è…³æœ¬ç”Ÿæˆå™¨ ğŸ¬</h1>
    <p class="text-gray-600">æ­¤ç‰ˆæœ¬è®“ä½¿ç”¨è€…è‡ªè¡Œè¼¸å…¥ OpenAI API Keyï¼Œè³‡æ–™åƒ…å„²å­˜åœ¨æœ¬æ©Ÿç€è¦½å™¨ã€‚</p>
  </header>

  <main class="max-w-4xl mx-auto px-4 space-y-6 pb-24">
    <!-- é‡‘é‘°è¼¸å…¥å€ -->
    <div class="card">
      <h2 class="text-xl font-semibold mb-3">ç¬¬ä¸€æ­¥ï¼šè¼¸å…¥ä½ çš„ OpenAI API Key</h2>
      <p class="text-sm text-gray-600 mb-3">è«‹è²¼ä¸Šä½ çš„ API é‡‘é‘°ï¼ˆé–‹é ­ç‚º <code>sk-</code>ï¼‰ã€‚æ­¤é‡‘é‘°åƒ…æœƒå„²å­˜åœ¨ä½ çš„ç€è¦½å™¨ï¼Œä¸æœƒä¸Šå‚³ã€‚</p>
      <div class="flex gap-2 items-center">
        <input id="userApiKey" type="password" placeholder="sk-xxxxxxxxxxxxxxxx" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400">
        <button id="btnSaveKey" class="btn btn-ghost">å„²å­˜</button>
        <button id="btnClearKey" class="btn btn-ghost">æ¸…é™¤</button>
      </div>
      <p id="keyHint" class="muted mt-2"></p>
    </div>

    <!-- æ–‡å­—è¼¸å…¥å€ï¼ˆå«å­—æ•¸é™åˆ¶é¡¯ç¤ºï¼‰ -->
    <div class="card">
      <h2 class="text-xl font-semibold mb-2">ç¬¬äºŒæ­¥ï¼šè²¼ä¸Šæ–‡ç« æˆ–é€å­—ç¨¿</h2>
      <div class="flex items-center justify-between mb-2">
        <div class="text-sm text-gray-700">ç›®å‰å­—æ•¸ä¸Šé™ï¼š<span id="charLimit" class="font-semibold"></span> å­—</div>
        <div class="text-sm text-gray-700">å·²è¼¸å…¥ï¼š<span id="charCount" class="font-semibold">0</span>ï¼å‰©é¤˜ï¼š<span id="charRemain" class="font-semibold">0</span></div>
      </div>
      <textarea id="inputText" rows="10" placeholder="è«‹è²¼ä¸Šé€å­—ç¨¿æˆ–æ–‡ç« å…§å®¹...ï¼ˆéé•·æœƒå…ˆè‡ªå‹•æ‘˜è¦ï¼‰" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400"></textarea>
      <p class="muted mt-2">æç¤ºï¼šè‹¥å…§å®¹é è¶…éä¸Šé™ï¼Œç³»çµ±å°‡åˆ†æ®µæ‘˜è¦å¾Œå†ç”Ÿæˆï¼Œç¢ºä¿ä¸è¶…éæ¨¡å‹çš„ token é™åˆ¶ã€‚</p>
    </div>

    <!-- å‹æ…‹é¸æ“‡ + æ¨¡å‹é¸æ“‡ + æµç¨‹é–‹é—œ -->
    <div class="card">
      <h2 class="text-xl font-semibold mb-3">ç¬¬ä¸‰æ­¥ï¼šé¸æ“‡å½±ç‰‡å‹æ…‹èˆ‡æ¨¡å‹</h2>
      <div class="space-y-2 mb-4">
        <label class="flex items-start gap-3">
          <input type="radio" name="mode" value="podcast" checked>
          <span><strong>Podcast ä¸€é¡åˆ°åº•å‹ï¼š</strong>æä¾› 5 æ®µ 45â€“75 ç§’é‡é»ç‰‡æ®µ</span>
        </label>
        <label class="flex items-start gap-3">
          <input type="radio" name="mode" value="topic">
          <span><strong>è­°é¡Œå‹ï¼š</strong>60 ç§’æ—ç™½è…³æœ¬ + å»ºè­°ç•«é¢</span>
        </label>
        <label class="flex items-start gap-3">
          <input type="radio" name="mode" value="people">
          <span><strong>äººç‰©æ•…äº‹å‹ï¼š</strong>åŸéŸ³æ‘˜éŒ„ + æ—ç™½ + ç•«é¢</span>
        </label>
      </div>

      <div class="flex flex-wrap items-center gap-3">
        <label class="text-sm text-gray-700">æ¨¡å‹ï¼š</label>
        <select id="modelSelect" class="p-2 border border-gray-300 rounded-lg">
          <option value="gpt-4o-mini" selected>gpt-4o-miniï¼ˆå»ºè­°ï¼‰</option>
          <option value="o4-mini">o4-miniï¼ˆå¼·åŒ–æ¨ç†ï¼‰</option>
          <option value="o3">o3ï¼ˆé«˜éšæ¨ç†ï¼‰</option>
          <option value="gpt-4.1-mini">gpt-4.1-mini</option>
        </select>
        <label class="flex items-center gap-2 ml-4 text-sm">
          <input type="checkbox" id="chkSummarizeFirst" checked>
          <span>å…ˆæ‘˜è¦ï¼Œå†ç”Ÿæˆï¼ˆå»ºè­°é–‹å•Ÿï¼‰</span>
        </label>
      </div>
      <p class="muted mt-2">æœ¬å·¥å…·é è¨­ä½¿ç”¨ <code>/v1/responses</code> ç«¯é»ï¼ˆæ–°ç‰ˆ Responses APIï¼‰ã€‚ä¸€èˆ¬ä½¿ç”¨è€…ä¸éœ€ç†è§£ç«¯é»ç´°ç¯€ã€‚</p>
    </div>

    <!-- ç”ŸæˆæŒ‰éˆ• -->
    <div class="card">
      <h2 class="text-xl font-semibold mb-3">ç¬¬å››æ­¥ï¼šç”Ÿæˆè…³æœ¬</h2>
      <button id="btnGenerate" class="btn btn-primary" disabled>ç¢ºèªç”Ÿæˆ</button>
      <p id="sysMsg" class="text-sm text-gray-600 mt-3"></p>
    </div>

    <!-- çµæœè¼¸å‡º -->
    <div class="card">
      <h2 class="text-xl font-semibold mb-3">çµæœï¼š</h2>
      <div class="flex flex-wrap gap-2 mb-3">
        <button id="btnCopy" class="btn btn-ghost">è¤‡è£½</button>
        <button id="btnDownload" class="btn btn-ghost">ä¸‹è¼‰ .txt</button>
      </div>
      <pre id="output" class="code"></pre>
    </div>
  </main>

  <script>
  // === å¯èª¿æ•´ä¸Šé™ï¼ˆä»¥ã€Œå­—å…ƒã€ä¼°ç®—ï¼ŒCJK å¸¸æ¥è¿‘ token æ•¸é‡ï¼‰ ===
  const INPUT_CHAR_LIMIT = 12000; // é¡¯ç¤ºçš„æœ€å¤§å»ºè­°è¼¸å…¥é•·åº¦
  const CHUNK_SIZE = 3000;        // åˆ†æ®µæ‘˜è¦æ™‚æ¯æ®µå¤§å°
  const SUMMARY_TARGET_CHARS = 1500; // å–®æ®µæ‘˜è¦æœŸæœ›é•·åº¦
  const USE_TIMEOUT_MS = 120_000;

  // === é‡‘é‘°å„²å­˜ ===
  const KEY_STORAGE = 'user_api_key';
  const MASK = '********';

  // === DOM ===
  const el = id => document.getElementById(id);
  const keyInput = el('userApiKey');
  const saveBtn = el('btnSaveKey');
  const clearBtn = el('btnClearKey');
  const generateBtn = el('btnGenerate');
  const output = el('output');
  const sysMsg = el('sysMsg');
  const keyHint = el('keyHint');
  const modelSelect = el('modelSelect');
  const chkSummarizeFirst = el('chkSummarizeFirst');
  const inputText = el('inputText');
  const charLimit = el('charLimit');
  const charCount = el('charCount');
  const charRemain = el('charRemain');

  // === ç‹€æ…‹ ===
  let userApiKey = localStorage.getItem(KEY_STORAGE) || '';
  if (userApiKey) {
    keyInput.value = MASK;
    keyHint.textContent = `ç›®å‰å·²å„²å­˜é‡‘é‘°ï¼šsk-****${userApiKey.slice(-4)}ï¼ˆåƒ…å­˜åœ¨ç€è¦½å™¨ï¼‰`;
  }
  charLimit.textContent = INPUT_CHAR_LIMIT.toLocaleString();
  updateCharCounter();
  updateGenerateButtonState();

  // === UIï¼šå­—æ•¸è¨ˆæ•¸ ===
  function updateCharCounter() {
    const len = inputText.value.length;
    charCount.textContent = len.toLocaleString();
    const remain = Math.max(0, INPUT_CHAR_LIMIT - len);
    charRemain.textContent = remain.toLocaleString();
    if (len > INPUT_CHAR_LIMIT) {
      charRemain.classList.add('warn');
    } else {
      charRemain.classList.remove('warn');
    }
  }
  inputText.addEventListener('input', updateCharCounter);

  function updateGenerateButtonState() {
    const ok = Boolean(userApiKey);
    generateBtn.disabled = !ok;
  }

  // === é‡‘é‘°æ“ä½œ ===
  saveBtn.addEventListener('click', () => {
    const val = keyInput.value.trim();
    if (val === MASK) return alert('é€™æ˜¯é®ç½©æ–‡å­—ï¼Œè«‹è²¼ä¸ŠçœŸæ­£çš„ API Keyï¼ˆsk- é–‹é ­ï¼‰ã€‚');
    if (!/^sk-[A-Za-z0-9]{20,}/.test(val)) return alert('è«‹è¼¸å…¥æ­£ç¢ºæ ¼å¼çš„ API Keyï¼ˆé–‹é ­ç‚º sk-ï¼‰');
    localStorage.setItem(KEY_STORAGE, val);
    userApiKey = val;
    keyInput.value = MASK;
    keyHint.textContent = `ç›®å‰å·²å„²å­˜é‡‘é‘°ï¼šsk-****${userApiKey.slice(-4)}ï¼ˆåƒ…å­˜åœ¨ç€è¦½å™¨ï¼‰`;
    alert('âœ… API Key å·²å„²å­˜æ–¼ç€è¦½å™¨');
    updateGenerateButtonState();
  });

  clearBtn.addEventListener('click', () => {
    localStorage.removeItem(KEY_STORAGE);
    userApiKey = '';
    keyInput.value = '';
    keyHint.textContent = '';
    alert('ğŸ”’ å·²æ¸…é™¤ API Key');
    updateGenerateButtonState();
  });

  // === OpenAI å‘¼å«ï¼ˆä½¿ç”¨ Responses APIï¼‰ ===
  async function callResponsesAPI({ model, input, signal }) {
    const res = await fetch('https://api.openai.com/v1/responses', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${userApiKey}`,
      },
      body: JSON.stringify({ model, input, temperature: 0.7 }),
      signal
    });

    const raw = await res.text();
    let data;
    try { data = JSON.parse(raw); } catch { data = null; }

    if (!res.ok) {
      const msg = data?.error?.message || raw || `HTTP ${res.status}`;
      throw new Error(`HTTP ${res.status} ${res.statusText}ï½œ${msg}`);
    }

    const textOut = data?.output_text
      || data?.content?.[0]?.text
      || data?.choices?.[0]?.message?.content
      || '';
    return textOut;
  }

  // === ä»»å‹™ï¼šæ‘˜è¦ ===
  function summaryPrompt(text, targetChars) {
    return `ä½ æ˜¯å°ˆæ¥­ä¸­æ–‡ç·¨è¼¯ï¼Œè«‹å°‡ä»¥ä¸‹æ–‡æœ¬é‡é»æ¿ƒç¸®ç‚ºä¸è¶…é ${targetChars} å­—çš„æ¢åˆ—å¼æ‘˜è¦ï¼Œä¿ç•™é—œéµäº‹å¯¦ã€äººç‰©ã€æ•¸æ“šèˆ‡è„ˆçµ¡ï¼Œä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚
\nã€åŸæ–‡ã€‘\n${text}`;
  }

  // === ä»»å‹™ï¼šè…³æœ¬ ===
  function buildScriptPrompt(mode, sourceText) {
    const base = `ä½ æ˜¯å°ç£ä¸­æ–‡å…§å®¹è£½ä½œçš„çŸ­å½±éŸ³è…³æœ¬ç·¨åŠ‡ï¼Œè«‹ç”¨ç¹é«”ä¸­æ–‡æ’°å¯« Markdown æ ¼å¼è¼¸å‡ºã€‚`;
    let task = '';
    if (mode === 'podcast') task = 'è«‹é¸å‡º 5 æ®µ 45â€“75 ç§’å¯ä¸€é¡åˆ°åº•çš„é‡é»ç‰‡æ®µï¼Œé™„æ™‚é–“ç¢¼èˆ‡é‡é»';
    else if (mode === 'topic') task = 'è«‹å¯«å‡º 60 ç§’è­°é¡Œå‹æ—ç™½è…³æœ¬ï¼Œé™„å»ºè­°æ™‚é–“èˆ‡ç•«é¢';
    else task = 'è«‹å¯«å‡º 60 ç§’äººç‰©æ•…äº‹å‹è…³æœ¬ï¼ŒåŒ…å«åŸéŸ³æ‘˜éŒ„ã€å¤§æ„èˆ‡å»ºè­°ç•«é¢';
    return `${base}\n${task}\nä»¥ä¸‹ç‚ºæ‘˜è¦å¾Œçš„é‡é»å…§å®¹ï¼š\n${sourceText}`;
  }

  // === å·¥å…·ï¼šåˆ†æ®µ ===
  function chunkText(text, size) {
    const chunks = [];
    for (let i = 0; i < text.length; i += size) {
      chunks.push(text.slice(i, i + size));
    }
    return chunks;
  }

  async function summarizeLongTextIfNeeded(text, model, signal) {
    if (!chkSummarizeFirst.checked) return text; // ç›´æ¥ç”¨åŸæ–‡

    if (text.length <= INPUT_CHAR_LIMIT) {
      // ä»å…ˆåšä¸€æ¬¡æ•´é«”æ‘˜è¦ï¼Œé™ä½ç¸½ token
      return await callResponsesAPI({ model, input: summaryPrompt(text, SUMMARY_TARGET_CHARS * 2), signal });
    }

    // è¶…éä¸Šé™ï¼šåˆ†æ®µæ‘˜è¦ â†’ åˆä½µæ‘˜è¦
    const parts = chunkText(text, CHUNK_SIZE);
    let partials = [];
    for (let i = 0; i < parts.length; i++) {
      const p = parts[i];
      sysMsg.textContent = `æ‘˜è¦ç¬¬ ${i+1}/${parts.length} æ®µâ€¦`;
      const s = await callResponsesAPI({ model, input: summaryPrompt(p, SUMMARY_TARGET_CHARS), signal });
      partials.push(`ã€ç¬¬${i+1}æ®µæ‘˜è¦ã€‘\n${s}`);
    }

    const merged = partials.join('\n\n');
    sysMsg.textContent = 'åˆä½µæ•´é«”æ‘˜è¦â€¦';
    const finalSummary = await callResponsesAPI({ model, input: summaryPrompt(merged, SUMMARY_TARGET_CHARS * 2), signal });
    return finalSummary;
  }

  // === ç”Ÿæˆ ===
  generateBtn.addEventListener('click', async () => {
    const raw = inputText.value.trim();
    if (!raw) return alert('è«‹å…ˆè²¼ä¸Šå…§å®¹');
    if (!userApiKey) return alert('è«‹å…ˆè¼¸å…¥ä½ çš„ OpenAI API Key');

    const mode = document.querySelector('input[name="mode"]:checked')?.value || 'topic';
    const model = modelSelect.value;

    output.textContent = 'â³ æ­£åœ¨ç”Ÿæˆä¸­...';
    sysMsg.textContent = 'è«‹ç¨å€™ï¼ŒAI æ­£åœ¨æ‘˜è¦èˆ‡æ’°å¯«è…³æœ¬';

    const ac = new AbortController();
    const timeout = setTimeout(() => ac.abort(), USE_TIMEOUT_MS);

    try {
      // 1) å…ˆæ‘˜è¦
      const summary = await summarizeLongTextIfNeeded(raw, model, ac.signal);

      // 2) å†ä¾æ¨¡å¼ç”Ÿæˆè…³æœ¬
      sysMsg.textContent = 'æ ¹æ“šæ‘˜è¦ç”Ÿæˆè…³æœ¬â€¦';
      const scriptPrompt = buildScriptPrompt(mode, summary || raw);
      const result = await callResponsesAPI({ model, input: scriptPrompt, signal: ac.signal });

      output.textContent = result;
      sysMsg.textContent = 'âœ… å·²å®Œæˆ';
    } catch (err) {
      output.textContent = 'âŒ éŒ¯èª¤ï¼š' + (err?.message || err);
      sysMsg.textContent = 'ç™¼ç”ŸéŒ¯èª¤ï¼ˆè«‹æŸ¥çœ‹ç€è¦½å™¨ Console èˆ‡ Networkï¼‰';
      console.error(err);
    } finally {
      clearTimeout(timeout);
    }
  });

  // === è¤‡è£½ / ä¸‹è¼‰ ===
  el('btnCopy').addEventListener('click', async () => {
    const text = output.textContent;
    if (!text) return;
    await navigator.clipboard.writeText(text);
    alert('âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
  });

  el('btnDownload').addEventListener('click', () => {
    const blob = new Blob([output.textContent], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'çŸ­å½±éŸ³è…³æœ¬.txt';
    a.click();
  });
  </script>
</body>
</html>
